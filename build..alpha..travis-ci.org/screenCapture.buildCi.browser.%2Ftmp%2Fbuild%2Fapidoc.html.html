<html><head></head><body><div class="apidocDiv">
<style>
/*csslint
*/
.apidocDiv {
    background: #fff;
    font-family: Arial, Helvetica, sans-serif;
}
.apidocDiv a[href] {
    color: #33f;
    font-weight: bold;
    text-decoration: none;
}
.apidocDiv a[href]:hover {
    text-decoration: underline;
}
.apidocCodeCommentSpan {
    background: #bbf;
    color: #000;
    display: block;
}
.apidocCodeKeywordSpan {
    color: #d00;
    font-weight: bold;
}
.apidocCodePre {
    background: #eef;
    border: 1px solid;
    color: #777;
    padding: 5px;
    white-space: pre-wrap;
}
.apidocFooterDiv {
    margin-top: 20px;
    text-align: center;
}
.apidocModuleLi {
    margin-top: 10px;
}
.apidocSectionDiv {
    border-top: 1px solid;
    margin-top: 20px;
}
.apidocSignatureSpan {
    color: #777;
    font-weight: bold;
}
</style>
<h1>api documentation for
    <a>neocrawler (v2.0.2)</a>
</h1>
<h4>Nodejs Distribute Crawler</h4>
<div class="apidocSectionDiv"><a href="#apidoc.tableOfContents" id="apidoc.tableOfContents"><h1>table of contents</h1></a><ol>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler">module neocrawler</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.call">
            function <span class="apidocSignatureSpan">neocrawler.</span>call
            <span class="apidocSignatureSpan">(responseClass, header, timeout, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.downloader">
            function <span class="apidocSignatureSpan">neocrawler.</span>downloader
            <span class="apidocSignatureSpan">(spiderCore)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.extractor">
            function <span class="apidocSignatureSpan">neocrawler.</span>extractor
            <span class="apidocSignatureSpan">(spiderCore)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.filter_list">
            function <span class="apidocSignatureSpan">neocrawler.</span>filter_list
            <span class="apidocSignatureSpan">(operator, filter)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.get">
            function <span class="apidocSignatureSpan">neocrawler.</span>get
            <span class="apidocSignatureSpan">(row)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.gfw_proxy">
            function <span class="apidocSignatureSpan">neocrawler.</span>gfw_proxy
            <span class="apidocSignatureSpan">(settings)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.index">
            function <span class="apidocSignatureSpan">neocrawler.</span>index
            <span class="apidocSignatureSpan">(settings)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.spider">
            function <span class="apidocSignatureSpan">neocrawler.</span>spider
            <span class="apidocSignatureSpan">(spiderCore)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.webconfig">
            function <span class="apidocSignatureSpan">neocrawler.</span>webconfig
            <span class="apidocSignatureSpan">(webconfigCore)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">neocrawler.</span>SSDB</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">neocrawler.</span>call.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">neocrawler.</span>downloader.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">neocrawler.</span>extractor.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">neocrawler.</span>filter_list.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">neocrawler.</span>gbk</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">neocrawler.</span>get.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">neocrawler.</span>gfw_proxy.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">neocrawler.</span>httpRequest</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">neocrawler.</span>index.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">neocrawler.</span>line_reader</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">neocrawler.</span>logging</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">neocrawler.</span>myredis</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">neocrawler.</span>qqwry</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">neocrawler.</span>routecontroller</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">neocrawler.</span>scan</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">neocrawler.</span>spider.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">neocrawler.</span>ssdb_redis</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">neocrawler.</span>utils</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">neocrawler.</span>webconfig.prototype</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.SSDB">module neocrawler.SSDB</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.SSDB.connect">
            function <span class="apidocSignatureSpan">neocrawler.SSDB.</span>connect
            <span class="apidocSignatureSpan">(host, port, timeout, listener)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.call">module neocrawler.call</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.call.call">
            function <span class="apidocSignatureSpan">neocrawler.</span>call
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.call.prototype">module neocrawler.call.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.call.prototype.complete">
            function <span class="apidocSignatureSpan">neocrawler.call.prototype.</span>complete
            <span class="apidocSignatureSpan">(err, data)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.downloader">module neocrawler.downloader</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.downloader.downloader">
            function <span class="apidocSignatureSpan">neocrawler.</span>downloader
            <span class="apidocSignatureSpan">(spiderCore)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.downloader.super_">
            function <span class="apidocSignatureSpan">neocrawler.downloader.</span>super_
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.downloader.prototype">module neocrawler.downloader.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.downloader.prototype.assembly">
            function <span class="apidocSignatureSpan">neocrawler.downloader.prototype.</span>assembly
            <span class="apidocSignatureSpan">(callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.downloader.prototype.browseIt">
            function <span class="apidocSignatureSpan">neocrawler.downloader.prototype.</span>browseIt
            <span class="apidocSignatureSpan">(urlinfo)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.downloader.prototype.download">
            function <span class="apidocSignatureSpan">neocrawler.downloader.prototype.</span>download
            <span class="apidocSignatureSpan">(urlinfo)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.downloader.prototype.downloadIt">
            function <span class="apidocSignatureSpan">neocrawler.downloader.prototype.</span>downloadIt
            <span class="apidocSignatureSpan">(urlinfo)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.downloader.prototype.downloadItAct">
            function <span class="apidocSignatureSpan">neocrawler.downloader.prototype.</span>downloadItAct
            <span class="apidocSignatureSpan">(urlinfo)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.downloader.prototype.getProxyListFromDb">
            function <span class="apidocSignatureSpan">neocrawler.downloader.prototype.</span>getProxyListFromDb
            <span class="apidocSignatureSpan">(label)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.downloader.prototype.get_page_encoding">
            function <span class="apidocSignatureSpan">neocrawler.downloader.prototype.</span>get_page_encoding
            <span class="apidocSignatureSpan">(header)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.downloader.prototype.refreshProxyList">
            function <span class="apidocSignatureSpan">neocrawler.downloader.prototype.</span>refreshProxyList
            <span class="apidocSignatureSpan">(downloader)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.downloader.prototype.transCookieKvPair">
            function <span class="apidocSignatureSpan">neocrawler.downloader.prototype.</span>transCookieKvPair
            <span class="apidocSignatureSpan">(json)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.extractor">module neocrawler.extractor</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.extractor.extractor">
            function <span class="apidocSignatureSpan">neocrawler.</span>extractor
            <span class="apidocSignatureSpan">(spiderCore)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.extractor.prototype">module neocrawler.extractor.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.extractor.prototype.__getTopLevelDomain">
            function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>__getTopLevelDomain
            <span class="apidocSignatureSpan">(domain)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.extractor.prototype.arrange_link">
            function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>arrange_link
            <span class="apidocSignatureSpan">(links)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.extractor.prototype.assembly">
            function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>assembly
            <span class="apidocSignatureSpan">(callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.extractor.prototype.checksublack">
            function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>checksublack
            <span class="apidocSignatureSpan">(keys, data)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.extractor.prototype.cssSelector">
            function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>cssSelector
            <span class="apidocSignatureSpan">($, expression, pick, index)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.extractor.prototype.cssSelectorPicker">
            function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>cssSelectorPicker
            <span class="apidocSignatureSpan">(val, pick)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.extractor.prototype.detectLink">
            function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>detectLink
            <span class="apidocSignatureSpan">(link)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.extractor.prototype.extract">
            function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>extract
            <span class="apidocSignatureSpan">(crawl_info)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.extractor.prototype.extract_data">
            function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>extract_data
            <span class="apidocSignatureSpan">(url, content, extract_rule, uppper_data, dom)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.extractor.prototype.extract_link">
            function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>extract_link
            <span class="apidocSignatureSpan">($, rules)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.extractor.prototype.getDrillRelation">
            function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>getDrillRelation
            <span class="apidocSignatureSpan">($, crawl_info)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.extractor.prototype.regexSelector">
            function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>regexSelector
            <span class="apidocSignatureSpan">(content, expression, index)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.extractor.prototype.validateContent">
            function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>validateContent
            <span class="apidocSignatureSpan">(crawl_info)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.extractor.prototype.wash_link">
            function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>wash_link
            <span class="apidocSignatureSpan">(pageurl, links)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.filter_list">module neocrawler.filter_list</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.filter_list.filter_list">
            function <span class="apidocSignatureSpan">neocrawler.</span>filter_list
            <span class="apidocSignatureSpan">(operator, filter)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.filter_list.prototype">module neocrawler.filter_list.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.filter_list.prototype.addFilter">
            function <span class="apidocSignatureSpan">neocrawler.filter_list.prototype.</span>addFilter
            <span class="apidocSignatureSpan">(filter)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.filter_list.prototype.get">
            function <span class="apidocSignatureSpan">neocrawler.filter_list.prototype.</span>get
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.gbk">module neocrawler.gbk</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.gbk.dc_GBK">
            function <span class="apidocSignatureSpan">neocrawler.gbk.</span>dc_GBK
            <span class="apidocSignatureSpan">(arr)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.get">module neocrawler.get</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.get.get">
            function <span class="apidocSignatureSpan">neocrawler.</span>get
            <span class="apidocSignatureSpan">(row)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.get.prototype">module neocrawler.get.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.get.prototype.addColumn">
            function <span class="apidocSignatureSpan">neocrawler.get.prototype.</span>addColumn
            <span class="apidocSignatureSpan">(cf, qualifier)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.get.prototype.getFields">
            function <span class="apidocSignatureSpan">neocrawler.get.prototype.</span>getFields
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.get.prototype.getRow">
            function <span class="apidocSignatureSpan">neocrawler.get.prototype.</span>getRow
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.get.prototype.setMaxVersions">
            function <span class="apidocSignatureSpan">neocrawler.get.prototype.</span>setMaxVersions
            <span class="apidocSignatureSpan">(maxVersions)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.get.prototype.setTimeRange">
            function <span class="apidocSignatureSpan">neocrawler.get.prototype.</span>setTimeRange
            <span class="apidocSignatureSpan">(minStamp, maxStamp)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.gfw_proxy">module neocrawler.gfw_proxy</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.gfw_proxy.gfw_proxy">
            function <span class="apidocSignatureSpan">neocrawler.</span>gfw_proxy
            <span class="apidocSignatureSpan">(settings)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.gfw_proxy.super_">
            function <span class="apidocSignatureSpan">neocrawler.gfw_proxy.</span>super_
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.gfw_proxy.prototype">module neocrawler.gfw_proxy.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.gfw_proxy.prototype.__chooseProxy">
            function <span class="apidocSignatureSpan">neocrawler.gfw_proxy.prototype.</span>__chooseProxy
            <span class="apidocSignatureSpan">(domain, ip, header, callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.gfw_proxy.prototype.__getProxyFromDb">
            function <span class="apidocSignatureSpan">neocrawler.gfw_proxy.prototype.</span>__getProxyFromDb
            <span class="apidocSignatureSpan">(domain, callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.gfw_proxy.prototype.__getTopLevelDomain">
            function <span class="apidocSignatureSpan">neocrawler.gfw_proxy.prototype.</span>__getTopLevelDomain
            <span class="apidocSignatureSpan">(domain)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.gfw_proxy.prototype.__voteProxy">
            function <span class="apidocSignatureSpan">neocrawler.gfw_proxy.prototype.</span>__voteProxy
            <span class="apidocSignatureSpan">(domain, ip, score, callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.gfw_proxy.prototype.ipInChina">
            function <span class="apidocSignatureSpan">neocrawler.gfw_proxy.prototype.</span>ipInChina
            <span class="apidocSignatureSpan">(ip)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.gfw_proxy.prototype.needProxy">
            function <span class="apidocSignatureSpan">neocrawler.gfw_proxy.prototype.</span>needProxy
            <span class="apidocSignatureSpan">(hostname, callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.gfw_proxy.prototype.proxyDaemon">
            function <span class="apidocSignatureSpan">neocrawler.gfw_proxy.prototype.</span>proxyDaemon
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.gfw_proxy.prototype.start">
            function <span class="apidocSignatureSpan">neocrawler.gfw_proxy.prototype.</span>start
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.httpRequest">module neocrawler.httpRequest</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.httpRequest.cssExtract">
            function <span class="apidocSignatureSpan">neocrawler.httpRequest.</span>cssExtract
            <span class="apidocSignatureSpan">(content, expression, pick, callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.httpRequest.getDom">
            function <span class="apidocSignatureSpan">neocrawler.httpRequest.</span>getDom
            <span class="apidocSignatureSpan">(content)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.httpRequest.regexExtract">
            function <span class="apidocSignatureSpan">neocrawler.httpRequest.</span>regexExtract
            <span class="apidocSignatureSpan">(content, expression, index)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.httpRequest.request">
            function <span class="apidocSignatureSpan">neocrawler.httpRequest.</span>request
            <span class="apidocSignatureSpan">(url, referer, cookie, proxy, timeout, isbin, callback, param)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.index">module neocrawler.index</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.index.index">
            function <span class="apidocSignatureSpan">neocrawler.</span>index
            <span class="apidocSignatureSpan">(settings)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.index.super_">
            function <span class="apidocSignatureSpan">neocrawler.index.</span>super_
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.index.prototype">module neocrawler.index.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.index.prototype.__chooseProxy">
            function <span class="apidocSignatureSpan">neocrawler.index.prototype.</span>__chooseProxy
            <span class="apidocSignatureSpan">(domain, ip, header, callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.index.prototype.__getProxyFromDb">
            function <span class="apidocSignatureSpan">neocrawler.index.prototype.</span>__getProxyFromDb
            <span class="apidocSignatureSpan">(domain, callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.index.prototype.__getTopLevelDomain">
            function <span class="apidocSignatureSpan">neocrawler.index.prototype.</span>__getTopLevelDomain
            <span class="apidocSignatureSpan">(domain)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.index.prototype.__voteProxy">
            function <span class="apidocSignatureSpan">neocrawler.index.prototype.</span>__voteProxy
            <span class="apidocSignatureSpan">(domain, ip, score, callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.index.prototype.proxyDaemon">
            function <span class="apidocSignatureSpan">neocrawler.index.prototype.</span>proxyDaemon
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.index.prototype.start">
            function <span class="apidocSignatureSpan">neocrawler.index.prototype.</span>start
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.line_reader">module neocrawler.line_reader</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.line_reader.eachLine">
            function <span class="apidocSignatureSpan">neocrawler.line_reader.</span>eachLine
            <span class="apidocSignatureSpan">(filename, cb, separator, encoding, bufferSize)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.line_reader.open">
            function <span class="apidocSignatureSpan">neocrawler.line_reader.</span>open
            <span class="apidocSignatureSpan">(filename, cb, separator, encoding, bufferSize)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.logging">module neocrawler.logging</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.logging.getLogger">
            function <span class="apidocSignatureSpan">neocrawler.logging.</span>getLogger
            <span class="apidocSignatureSpan">(name, instance, level)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.myredis">module neocrawler.myredis</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.myredis.createClient">
            function <span class="apidocSignatureSpan">neocrawler.myredis.</span>createClient
            <span class="apidocSignatureSpan">(host, port, db, type, callback)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.qqwry">module neocrawler.qqwry</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.qqwry.DBUG">
            function <span class="apidocSignatureSpan">neocrawler.qqwry.</span>DBUG
            <span class="apidocSignatureSpan">(a)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.qqwry.info">
            function <span class="apidocSignatureSpan">neocrawler.qqwry.</span>info
            <span class="apidocSignatureSpan">(dataPath)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.qqwry.infoAsync">
            function <span class="apidocSignatureSpan">neocrawler.qqwry.</span>infoAsync
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.qqwry.intToIP">
            function <span class="apidocSignatureSpan">neocrawler.qqwry.</span>intToIP
            <span class="apidocSignatureSpan">(INT)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.qqwry.ipEndianChange">
            function <span class="apidocSignatureSpan">neocrawler.qqwry.</span>ipEndianChange
            <span class="apidocSignatureSpan">(INT)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.qqwry.ipToInt">
            function <span class="apidocSignatureSpan">neocrawler.qqwry.</span>ipToInt
            <span class="apidocSignatureSpan">(IP)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.qqwry.searchIP">
            function <span class="apidocSignatureSpan">neocrawler.qqwry.</span>searchIP
            <span class="apidocSignatureSpan">(IP)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.qqwry.searchIPScope">
            function <span class="apidocSignatureSpan">neocrawler.qqwry.</span>searchIPScope
            <span class="apidocSignatureSpan">(bginIP, endIP, callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.qqwry.searchIPScopeAsync">
            function <span class="apidocSignatureSpan">neocrawler.qqwry.</span>searchIPScopeAsync
            <span class="apidocSignatureSpan">(a, b, c)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.routecontroller">module neocrawler.routecontroller</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.routecontroller.mapRoute">
            function <span class="apidocSignatureSpan">neocrawler.routecontroller.</span>mapRoute
            <span class="apidocSignatureSpan">(app)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.scan">module neocrawler.scan</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.scan.Scan">
            function <span class="apidocSignatureSpan">neocrawler.scan.</span>Scan
            <span class="apidocSignatureSpan">(table, startRow, stopRow, client)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.scan.getFilter">
            function <span class="apidocSignatureSpan">neocrawler.scan.</span>getFilter
            <span class="apidocSignatureSpan">(filter)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.spider">module neocrawler.spider</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.spider.spider">
            function <span class="apidocSignatureSpan">neocrawler.</span>spider
            <span class="apidocSignatureSpan">(spiderCore)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.spider.prototype">module neocrawler.spider.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.spider.prototype.__getTopLevelDomain">
            function <span class="apidocSignatureSpan">neocrawler.spider.prototype.</span>__getTopLevelDomain
            <span class="apidocSignatureSpan">(domain)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.spider.prototype.assembly">
            function <span class="apidocSignatureSpan">neocrawler.spider.prototype.</span>assembly
            <span class="apidocSignatureSpan">(callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.spider.prototype.checkQueue">
            function <span class="apidocSignatureSpan">neocrawler.spider.prototype.</span>checkQueue
            <span class="apidocSignatureSpan">(spider)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.spider.prototype.detectLink">
            function <span class="apidocSignatureSpan">neocrawler.spider.prototype.</span>detectLink
            <span class="apidocSignatureSpan">(link)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.spider.prototype.getDrillerRule">
            function <span class="apidocSignatureSpan">neocrawler.spider.prototype.</span>getDrillerRule
            <span class="apidocSignatureSpan">(id, name)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.spider.prototype.getDrillerRules">
            function <span class="apidocSignatureSpan">neocrawler.spider.prototype.</span>getDrillerRules
            <span class="apidocSignatureSpan">(id)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.spider.prototype.getUrlQueue">
            function <span class="apidocSignatureSpan">neocrawler.spider.prototype.</span>getUrlQueue
            <span class="apidocSignatureSpan">(callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.spider.prototype.jsonSmartDeepParse">
            function <span class="apidocSignatureSpan">neocrawler.spider.prototype.</span>jsonSmartDeepParse
            <span class="apidocSignatureSpan">(obj)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.spider.prototype.refreshDrillerRules">
            function <span class="apidocSignatureSpan">neocrawler.spider.prototype.</span>refreshDrillerRules
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.spider.prototype.retryCrawl">
            function <span class="apidocSignatureSpan">neocrawler.spider.prototype.</span>retryCrawl
            <span class="apidocSignatureSpan">(urlinfo)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.spider.prototype.updateLinkState">
            function <span class="apidocSignatureSpan">neocrawler.spider.prototype.</span>updateLinkState
            <span class="apidocSignatureSpan">(link, state, callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.spider.prototype.wrapLink">
            function <span class="apidocSignatureSpan">neocrawler.spider.prototype.</span>wrapLink
            <span class="apidocSignatureSpan">(link)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.spider.prototype.wrapper_rules">
            function <span class="apidocSignatureSpan">neocrawler.spider.prototype.</span>wrapper_rules
            <span class="apidocSignatureSpan">(key)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.ssdb_redis">module neocrawler.ssdb_redis</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.ssdb_redis.client">
            function <span class="apidocSignatureSpan">neocrawler.ssdb_redis.</span>client
            <span class="apidocSignatureSpan">(host, port)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.utils">module neocrawler.utils</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.utils.bufferCompare">
            function <span class="apidocSignatureSpan">neocrawler.utils.</span>bufferCompare
            <span class="apidocSignatureSpan">(a, b)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.utils.bufferIncrement">
            function <span class="apidocSignatureSpan">neocrawler.utils.</span>bufferIncrement
            <span class="apidocSignatureSpan">(buffer, i)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.webconfig">module neocrawler.webconfig</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.webconfig.webconfig">
            function <span class="apidocSignatureSpan">neocrawler.</span>webconfig
            <span class="apidocSignatureSpan">(webconfigCore)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.neocrawler.webconfig.prototype">module neocrawler.webconfig.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.neocrawler.webconfig.prototype.launch">
            function <span class="apidocSignatureSpan">neocrawler.webconfig.prototype.</span>launch
            <span class="apidocSignatureSpan">(settings)</span>
            </a>

        </li>

    </ol></li>

</ol></div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler" id="apidoc.module.neocrawler">module neocrawler</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.call" id="apidoc.element.neocrawler.call">
        function <span class="apidocSignatureSpan">neocrawler.</span>call
        <span class="apidocSignatureSpan">(responseClass, header, timeout, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Call(responseClass, header, timeout, cb) {
  this.responseClass = responseClass;
  this.header = header;
  this.timeout = timeout;
  this.cb = cb;
  this.complete = __bind(this.complete, this);
  this.called = false;
  this.startTime = new Date;
  this.timer = setTimeout((function(_this) {
    return function() {
      debug("operation " + _this.header.callId + " (" + _this.header.methodName + ") timedout after " + _this.timeout + "ms");
      _this.called = true;
      return _this.cb('timedout');
    };
  })(this), this.timeout);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var myredis = require('../lib/myredis.js');
require('../lib/jsextend.js');
var logger;
var PROXY_KEYS = 'proxy:public:available:3s';

/////////////////////////////////////////////////////////////////
var proxyRouter = function(settings){
	events.EventEmitter.<span class="apidocCodeKeywordSpan">call</span>(this);//eventemitter inherits
	this.settings = settings;
	logger = settings['logger'];
    this.handleCount = 0;//proxy handle count. once proxy list change, reset to 0.
    this.proxyServeMap = {};
    this.availableProxies = {};/*{domain:{$IP$:true}}*/
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.downloader" id="apidoc.element.neocrawler.downloader">
        function <span class="apidocSignatureSpan">neocrawler.</span>downloader
        <span class="apidocSignatureSpan">(spiderCore)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">downloader = function (spiderCore){
    events.EventEmitter.call(this);//eventemitter inherits
    this.spiderCore = spiderCore;
    this.proxyList = [];
    this.timeout_count = 0;
    logger = spiderCore.settings.logger;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.extractor" id="apidoc.element.neocrawler.extractor">
        function <span class="apidocSignatureSpan">neocrawler.</span>extractor
        <span class="apidocSignatureSpan">(spiderCore)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">extractor = function (spiderCore){
    this.spiderCore = spiderCore;
    logger = spiderCore.settings.logger;
    this.cumulative_failure = 0;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.filter_list" id="apidoc.element.neocrawler.filter_list">
        function <span class="apidocSignatureSpan">neocrawler.</span>filter_list
        <span class="apidocSignatureSpan">(operator, filter)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function FilterList(operator, filter) {
  var _ref;
  this.operator = operator;
  this.get = __bind(this.get, this);
  this.addFilter = __bind(this.addFilter, this);
  if ((_ref = this.operator) !== 'MUST_PASS_ALL' &amp;&amp; _ref !== 'MUST_PASS_ONE') {
    this.operator = 'MUST_PASS_ALL';
  }
  this.filters = [];
  if (filter) {
    filter = getFilter(filter);
    if (!filter) {
      return false;
    }
    this.filters.push(filter);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.get" id="apidoc.element.neocrawler.get">
        function <span class="apidocSignatureSpan">neocrawler.</span>get
        <span class="apidocSignatureSpan">(row)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Get(row) {
  this.row = row;
  this.getRow = __bind(this.getRow, this);
  this.getFields = __bind(this.getFields, this);
  this.setTimeRange = __bind(this.setTimeRange, this);
  this.setMaxVersions = __bind(this.setMaxVersions, this);
  this.addColumn = __bind(this.addColumn, this);
  this.tr = {
    from: null,
    to: null
  };
  this.familyMap = {};
  this.maxVersions = 1;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var redis_cli = function(host,port){
    this.ssdb_cli = SSDB.connect(host, port,30*1000,function(err,errobj){
        if(err)throw errobj;
    });
}

redis_cli.prototype.get = function(key,callback){
    this.ssdb_cli.<span class="apidocCodeKeywordSpan">get</span>(key,callback);
}

redis_cli.prototype.set = function(key,value,callback){
    this.ssdb_cli.set(key,value,callback);
}

redis_cli.prototype.expire = function(key,sec,callback){
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.gfw_proxy" id="apidoc.element.neocrawler.gfw_proxy">
        function <span class="apidocSignatureSpan">neocrawler.</span>gfw_proxy
        <span class="apidocSignatureSpan">(settings)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">gfw_proxy = function (settings){
	events.EventEmitter.call(this);//eventemitter inherits
	this.settings = settings;
	logger = settings['logger'];
    this.handleCount = 0;//proxy handle count. once proxy list change, reset to 0.
    this.proxyServeMap = {};
    this.availableProxies = {};/*{domain:{$IP$:true}}*/
    this.resolvCache = {
        '192.168.72.11':false,
        '192.168.72.29':false,
        '192.168.72.34':false
    };
    this.dnsCache = {
        'backee':'10.1.1.122'
    };
    qqwry.info();
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.index" id="apidoc.element.neocrawler.index">
        function <span class="apidocSignatureSpan">neocrawler.</span>index
        <span class="apidocSignatureSpan">(settings)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">index = function (settings){
	events.EventEmitter.call(this);//eventemitter inherits
	this.settings = settings;
	logger = settings['logger'];
    this.handleCount = 0;//proxy handle count. once proxy list change, reset to 0.
    this.proxyServeMap = {};
    this.availableProxies = {};/*{domain:{$IP$:true}}*/
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.spider" id="apidoc.element.neocrawler.spider">
        function <span class="apidocSignatureSpan">neocrawler.</span>spider
        <span class="apidocSignatureSpan">(spiderCore)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">spider = function (spiderCore){
    this.spiderCore = spiderCore;
    this.queue_length = 0;
    this.driller_rules_updated = 0;
    this.driller_rules = {};
    logger = spiderCore.settings.logger;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.webconfig" id="apidoc.element.neocrawler.webconfig">
        function <span class="apidocSignatureSpan">neocrawler.</span>webconfig
        <span class="apidocSignatureSpan">(webconfigCore)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">webconfig = function (webconfigCore){
	events.EventEmitter.call(this);
	this.webconfigCore = webconfigCore;
	logger = webconfigCore.settings.logger;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>










































</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.SSDB" id="apidoc.module.neocrawler.SSDB">module neocrawler.SSDB</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.SSDB.connect" id="apidoc.element.neocrawler.SSDB.connect">
        function <span class="apidocSignatureSpan">neocrawler.SSDB.</span>connect
        <span class="apidocSignatureSpan">(host, port, timeout, listener)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">connect = function (host, port, timeout, listener){
    return new SSDBConnect(host, port, timeout, listener);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    if(!connected){
        listener('connect_failed', e);
    }else{
        var callback = callbacks.shift();
        if(callback)callback(['error']);
    }
});
sock.<span class="apidocCodeKeywordSpan">connect</span>(port, host, function(){
    connected = true;
    sock.setNoDelay(true);
    sock.setKeepAlive(true);
    sock.setTimeout(timeout);
    listener(0, self);
});
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.call" id="apidoc.module.neocrawler.call">module neocrawler.call</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.call.call" id="apidoc.element.neocrawler.call.call">
        function <span class="apidocSignatureSpan">neocrawler.</span>call
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function call() { [native code] }</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var myredis = require('../lib/myredis.js');
require('../lib/jsextend.js');
var logger;
var PROXY_KEYS = 'proxy:public:available:3s';

/////////////////////////////////////////////////////////////////
var proxyRouter = function(settings){
	events.EventEmitter.<span class="apidocCodeKeywordSpan">call</span>(this);//eventemitter inherits
	this.settings = settings;
	logger = settings['logger'];
    this.handleCount = 0;//proxy handle count. once proxy list change, reset to 0.
    this.proxyServeMap = {};
    this.availableProxies = {};/*{domain:{$IP$:true}}*/
}
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.call.prototype" id="apidoc.module.neocrawler.call.prototype">module neocrawler.call.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.call.prototype.complete" id="apidoc.element.neocrawler.call.prototype.complete">
        function <span class="apidocSignatureSpan">neocrawler.call.prototype.</span>complete
        <span class="apidocSignatureSpan">(err, data)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">complete = function (err, data) {
  if (this.called) {
    return;
  }
  debug("operation " + this.header.callId + " (" + this.header.methodName + ") completed. Took: " + (new Date - this.startTime) + "
ms");
  clearTimeout(this.timer);
  return this.cb(err, data);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.downloader" id="apidoc.module.neocrawler.downloader">module neocrawler.downloader</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.downloader.downloader" id="apidoc.element.neocrawler.downloader.downloader">
        function <span class="apidocSignatureSpan">neocrawler.</span>downloader
        <span class="apidocSignatureSpan">(spiderCore)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">downloader = function (spiderCore){
    events.EventEmitter.call(this);//eventemitter inherits
    this.spiderCore = spiderCore;
    this.proxyList = [];
    this.timeout_count = 0;
    logger = spiderCore.settings.logger;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.downloader.super_" id="apidoc.element.neocrawler.downloader.super_">
        function <span class="apidocSignatureSpan">neocrawler.downloader.</span>super_
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function EventEmitter() {
  EventEmitter.init.call(this);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.downloader.prototype" id="apidoc.module.neocrawler.downloader.prototype">module neocrawler.downloader.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.downloader.prototype.assembly" id="apidoc.element.neocrawler.downloader.prototype.assembly">
        function <span class="apidocSignatureSpan">neocrawler.downloader.prototype.</span>assembly
        <span class="apidocSignatureSpan">(callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">assembly = function (callback){
    /*
    var downloader = this;
    var MIN_PROXY_LENGTH = 1000;
    downloader.on('gotProxyList',function(label,proxylist){
        if(proxylist&amp;&amp;proxylist.length&gt;0)downloader.tmp_proxyList = downloader.tmp_proxyList.concat(proxylist);
        switch(label){
            case 'proxy:vip:available:1s':
                if(downloader.tmp_proxyList.length&lt;MIN_PROXY_LENGTH)this.getProxyListFromDb('proxy:vip:available:3s');
                else {
                    downloader.proxyList = downloader.tmp_proxyList;
                    downloader.emit('refreshed_proxy_list',downloader.proxyList);
                }
                break;
            case 'proxy:vip:available:3s':
                if(downloader.tmp_proxyList.length&lt;MIN_PROXY_LENGTH)this.getProxyListFromDb('proxy:public:available:1s');
                else {
                    downloader.proxyList = downloader.tmp_proxyList;
                    downloader.emit('refreshed_proxy_list',downloader.proxyList);
                }
                break;
            case 'proxy:public:available:1s':
                if(downloader.tmp_proxyList.length&lt;MIN_PROXY_LENGTH)this.getProxyListFromDb('proxy:public:available:3s');
                else {
                    downloader.proxyList = downloader.tmp_proxyList;
                    downloader.emit('refreshed_proxy_list',downloader.proxyList);
                }
                break;
            case 'proxy:public:available:3s':
                if(downloader.tmp_proxyList.length&lt;MIN_PROXY_LENGTH)logger.warn(util.format('Only %d proxies !!!',downloader.tmp_proxyList
.length));
                if(downloader.tmp_proxyList.length&lt;0)throw new Error('no proxy list');
                else{
                    downloader.proxyList = downloader.tmp_proxyList;
                    downloader.emit('refreshed_proxy_list',downloader.proxyList);
                }
                break;
        }
    });
    this.redis_cli3 = redis.createClient(this.spiderCore.settings['proxy_info_redis_db'][1],this.spiderCore.settings['proxy_info_redis_db
'][0]);
    if(this.spiderCore.settings['use_proxy']){
        downloader.redis_cli3.select(downloader.spiderCore.settings['proxy_info_redis_db'][2], function(err,value) {
             if(err)throw(err);
             downloader.refreshProxyList(downloader);
             downloader.on('refreshed_proxy_list',function(proxylist){
                 downloader.spiderCore.emit('standby','downloader');
                 setTimeout(function(){downloader.refreshProxyList(downloader)},10*60*1000);//refresh again after 10 mins
             });
         });

    }else{
        this.spiderCore.emit('standby','downloader');
    }
    */
    if(callback)callback(null,'done');
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.downloader.prototype.browseIt" id="apidoc.element.neocrawler.downloader.prototype.browseIt">
        function <span class="apidocSignatureSpan">neocrawler.downloader.prototype.</span>browseIt
        <span class="apidocSignatureSpan">(urlinfo)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">browseIt = function (urlinfo){
    var spiderCore = this.spiderCore;
    if(this.spiderCore.settings['test']){
        urlinfo['test'] = true;
        urlinfo['ipath'] = path.join(__dirname,'..', 'instance',this.spiderCore.settings['instance'],'logs');
    }
    var useProxy = false;
    if(urlinfo['urllib']&amp;&amp;spiderCore.settings['use_proxy']===true){
        if(spiderCore.spider.getDrillerRule(urlinfo['urllib'],'use_proxy')===true)useProxy=true;
    }
    if(useProxy){
        var phantomjs = child_process.spawn('./phantomjs', [
            '--proxy', this.spiderCore.settings['proxy_router'],
            '--load-images', 'false',
            '--local-to-remote-url-access','true',
            //'--cookies-file',path.join(__dirname,'..', 'instance',this.spiderCore.settings['instance'],'logs','cookies.log'),
            'phantomjs-bridge.js',
            JSON.stringify(urlinfo)],
            {'cwd':path.join(__dirname,'..', 'lib','phantomjs'),
                'stdio':'pipe'}
        );
    }else{
        var phantomjs = child_process.spawn('./phantomjs', [
            '--load-images', 'false',
            '--local-to-remote-url-access','true',
            //'--cookies-file',path.join(__dirname,'..', 'instance',this.spiderCore.settings['instance'],'logs','cookies.log'),
            'phantomjs-bridge.js',
            JSON.stringify(urlinfo)],
            {'cwd':path.join(__dirname,'..', 'lib','phantomjs'),
                'stdio':'pipe'}
        );
    }

    phantomjs.stdin.setEncoding('utf8');
    phantomjs.stdout.setEncoding('utf8');

    phantomjs.on('error',function(err){logger.error(err);});

    var feedback = '';
    phantomjs.stdout.on('data', function(data) {
        data = data.trim();
        if(feedback==''&amp;&amp;!data.startsWith('{')){
            logger.warn('phantomjs: '+data);
        }else{
            feedback += data;
            if(data.endsWith('}#^_^#')){
                var emit_string = feedback.slice(0,-5);
                feedback = '';
                phantomjs.emit('feedback',emit_string);
            }
        }
    });

    phantomjs.on('feedback', function(data) {
        try{
            var feedback = JSON.parse(data);//data.toString('utf8')
        }catch(e){
            logger.error(util.format('Page content parse error: %s',e));
            spiderCore.emit('crawling_break',urlinfo,e.message);
            phantomjs.kill();
            return;
        }
        switch(feedback['signal']){
            case CMD_SIGNAL_CRAWL_SUCCESS:
                spiderCore.emit('crawled',feedback);
                break;
            case CMD_SIGNAL_CRAWL_FAIL:
                logger.error(feedback.url+' crawled fail');
                phantomjs.kill();
                if(feedback['url']==urlinfo['url'])spiderCore.emit('crawling_failure',urlinfo,'phantomjs crawl failure');
                break;
            case CMD_SIGNAL_NAVIGATE_EXCEPTION:
                logger.error(feedback.url+' navigate fail');
                phantomjs.kill();
                break;
            default:
                logger.debug('Phantomjs: '+data);
        }
    });

    phantomjs.stderr.on('data', function (data) {
        logger.error(data.toString('utf8'));
    });

    phantomjs.on('exit', function (code) {
        if(code!=0)logger.error('child process exited with code ' + code);
    });

    phantomjs.on('close', function (signal) {
        if(signal!=0)logger.error('child process closed with signal ' + signal);
    });

}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    if(err)throw(err);
    downloader.emit('gotProxyList',label,proxylist);
});
}

////download action/////////////////////
downloader.prototype.download = function (urlinfo){
if(urlinfo['jshandle'])this.<span class="apidocCodeKeywordSpan">browseIt</span>(urlinfo);
else this.downloadIt(urlinfo);
}

downloader.prototype.transCookieKvPair = function(json){
var kvarray = [];
for(var i=0; i&lt;json.length; i++){
    kvarray.push(json[i]['name']+'='+json[i]['value']);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.downloader.prototype.download" id="apidoc.element.neocrawler.downloader.prototype.download">
        function <span class="apidocSignatureSpan">neocrawler.downloader.prototype.</span>download
        <span class="apidocSignatureSpan">(urlinfo)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">download = function (urlinfo){
    if(urlinfo['jshandle'])this.browseIt(urlinfo);
    else this.downloadIt(urlinfo);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
 * just download html stream
 * @param urlinfo
 */
downloader.prototype.downloadIt = function(urlinfo){
var spiderCore = this.spiderCore;
var self = this;
if('download' in spiderCore.spider_extend){
    spiderCore.spider_extend.<span class="apidocCodeKeywordSpan">download</span>(urlinfo,function(err,result){
        if(err==null&amp;&amp;result==null){
            self.downloadItAct(urlinfo);//if all return null, download it use http request
        }else{
            if(err)spiderCore.emit('crawling_failure',urlinfo,err);
            else spiderCore.emit('crawled',result);
        }
    });
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.downloader.prototype.downloadIt" id="apidoc.element.neocrawler.downloader.prototype.downloadIt">
        function <span class="apidocSignatureSpan">neocrawler.downloader.prototype.</span>downloadIt
        <span class="apidocSignatureSpan">(urlinfo)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">downloadIt = function (urlinfo){
    var spiderCore = this.spiderCore;
    var self = this;
    if('download' in spiderCore.spider_extend){
        spiderCore.spider_extend.download(urlinfo,function(err,result){
            if(err==null&amp;&amp;result==null){
                self.downloadItAct(urlinfo);//if all return null, download it use http request
            }else{
                if(err)spiderCore.emit('crawling_failure',urlinfo,err);
                else spiderCore.emit('crawled',result);
            }
        });
    }else self.downloadItAct(urlinfo);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    downloader.emit('gotProxyList',label,proxylist);
});
}

////download action/////////////////////
downloader.prototype.download = function (urlinfo){
if(urlinfo['jshandle'])this.browseIt(urlinfo);
else this.<span class="apidocCodeKeywordSpan">downloadIt</span>(urlinfo);
}

downloader.prototype.transCookieKvPair = function(json){
var kvarray = [];
for(var i=0; i&lt;json.length; i++){
    kvarray.push(json[i]['name']+'='+json[i]['value']);
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.downloader.prototype.downloadItAct" id="apidoc.element.neocrawler.downloader.prototype.downloadItAct">
        function <span class="apidocSignatureSpan">neocrawler.downloader.prototype.</span>downloadItAct
        <span class="apidocSignatureSpan">(urlinfo)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">downloadItAct = function (urlinfo){
    var spiderCore = this.spiderCore;
    var self = this;

    var timeOuter = false;
    var pageLink = urlinfo['url'];
    if(urlinfo['redirect'])pageLink = urlinfo['redirect'];

    var useProxy = false;
    if(urlinfo['urllib']&amp;&amp;spiderCore.settings['use_proxy']===true){
        if(spiderCore.spider.getDrillerRule(urlinfo['urllib'],'use_proxy')===true)useProxy=true;
    }

    if(useProxy){
        var proxyRouter = spiderCore.settings['proxy_router'].split(':');
        var __host = proxyRouter[0];
        var __port = proxyRouter[1];
        var __path =  pageLink;
    }else{
        var urlobj = urlUtil.parse(pageLink);
        var __host = urlobj['hostname'];
        var __port = urlobj['port'];
        var __path = urlobj['path'];
//        var __path = pageLink;
    }


    var startTime = new Date();
    var options = {
        'host': __host,
        'port': __port,
        'path': __path,
        'method': 'GET',
        'headers': {
            "User-Agent":"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like NeoCrawler) Chrome/31.0.1650.57 Safari
/537.36",
            "Accept":"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",
            "Accept-Encoding":"gzip",
            "Accept-Language":"zh-CN,zh;q=0.8,en-US;q=0.6,en;q=0.4",
            "Referer":urlinfo['referer']||'',
            "void-proxy":urlinfo['void_proxy']?urlinfo['void_proxy']:"",
            "Cookie":this.transCookieKvPair(urlinfo['cookie'])
        }
    };
    logger.debug(util.format('Request start, %s',pageLink));
    var req = http.request(options, function(res) {
        logger.debug(util.format('Response, %s',pageLink));

        var result = {
            "remote_proxy":res.headers['remoteproxy'],
            "drill_count":0,
            "cookie":res.headers['Cookie'],
            "url":urlinfo['url'],
            //"url":res.req.path,
            //"statusCode":res.statusCode,
            "origin":urlinfo
        };
        if(result['url'].startsWith('/'))result['url'] = urlUtil.resolve(pageLink,result['url']);
        result['statusCode'] = res.statusCode;
        if(parseInt(res.statusCode)==301||parseInt(res.statusCode)==302){
            if(res.headers['location']){
                result['origin']['redirect'] = urlUtil.resolve(pageLink,res.headers['location']);
                logger.debug(pageLink+' 301 Moved Permanently to '+res.headers['location']);
            }
        }

        var compressed = /gzip|deflate/.test(res.headers['content-encoding']);

        var bufferHelper = new BufferHelper();
//        res.setEncoding('utf8');

        res.on('data', function (chunk) {
            bufferHelper.concat(chunk);
        });

        res.on('end', function (chunk) {
            self.timeout_count--;
            if(timeOuter){
                clearTimeout(timeOuter);
                timeOuter = false;
            }
            result["cost"] = (new Date()) - startTime;
            logger.debug('download '+pageLink+', cost:'+result["cost"]+'ms');


            var page_encoding = urlinfo['encoding'];

            if(page_encoding==='auto'){
                page_encoding = self.get_page_encoding(res.headers);
            }

            page_encoding = page_encoding.toLowerCase().replace('\-','')
            if(!compressed || typeof unzip == 'undefined'){
                if(urlinfo['format']=='binary'){
                    result["content"] = bufferHelper.toBuffer();
                }else{
                    result["content"] = iconv.decode(bufferHelper.toBuffer(),page_encoding);//page_encoding
                }
                spiderCore.emit('crawled',result);
            }else{
                unzip(bufferHelper.toBuffer(), function(err, buff) {
                    if (!err &amp;&amp; buff) {
                        if(urlinfo['format']=='binary'){
                            result["content"] = buff;
                        }else{
                            resu ...</pre></li>
    <li>example usage<pre class="apidocCodePre">...
 */
downloader.prototype.downloadIt = function(urlinfo){
    var spiderCore = this.spiderCore;
    var self = this;
    if('download' in spiderCore.spider_extend){
        spiderCore.spider_extend.download(urlinfo,function(err,result){
            if(err==null&amp;&amp;result==null){
                self.<span class="apidocCodeKeywordSpan">downloadItAct</span>(urlinfo);//if all return null, download it use http
 request
            }else{
                if(err)spiderCore.emit('crawling_failure',urlinfo,err);
                else spiderCore.emit('crawled',result);
            }
        });
    }else self.downloadItAct(urlinfo);
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.downloader.prototype.getProxyListFromDb" id="apidoc.element.neocrawler.downloader.prototype.getProxyListFromDb">
        function <span class="apidocSignatureSpan">neocrawler.downloader.prototype.</span>getProxyListFromDb
        <span class="apidocSignatureSpan">(label)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">getProxyListFromDb = function (label){
    var downloader = this;
    logger.debug(util.format('get proxy list from :%s',label));
    downloader.redis_cli3.lrange(label,0,-1,function(err,proxylist){
        if(err)throw(err);
        downloader.emit('gotProxyList',label,proxylist);
    });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
/*
var downloader = this;
var MIN_PROXY_LENGTH = 1000;
downloader.on('gotProxyList',function(label,proxylist){
    if(proxylist&amp;&amp;proxylist.length&gt;0)downloader.tmp_proxyList = downloader.tmp_proxyList.concat(proxylist);
    switch(label){
        case 'proxy:vip:available:1s':
            if(downloader.tmp_proxyList.length&lt;MIN_PROXY_LENGTH)this.<span class="apidocCodeKeywordSpan">getProxyListFromDb
</span>('proxy:vip:available:3s');
            else {
                downloader.proxyList = downloader.tmp_proxyList;
                downloader.emit('refreshed_proxy_list',downloader.proxyList);
            }
            break;
        case 'proxy:vip:available:3s':
            if(downloader.tmp_proxyList.length&lt;MIN_PROXY_LENGTH)this.getProxyListFromDb('proxy:public:available:1s'
;);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.downloader.prototype.get_page_encoding" id="apidoc.element.neocrawler.downloader.prototype.get_page_encoding">
        function <span class="apidocSignatureSpan">neocrawler.downloader.prototype.</span>get_page_encoding
        <span class="apidocSignatureSpan">(header)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">get_page_encoding = function (header){
    var page_encoding = 'UTF-8';
    //get the encoding from header
    if(header['content-type']!=undefined){
        var contentType = header['content-type'];
        var patt = new RegExp("^.*?charset\=(.+)$","ig");
        var mts = patt.exec(contentType);
        if (mts != null)
        {
            page_encoding = mts[1];
        }
    }
    return page_encoding;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
result["cost"] = (new Date()) - startTime;
logger.debug('download '+pageLink+', cost:'+result["cost"]+'ms');


var page_encoding = urlinfo['encoding'];

if(page_encoding==='auto'){
    page_encoding = self.<span class="apidocCodeKeywordSpan">get_page_encoding</span>(res.headers);
}

page_encoding = page_encoding.toLowerCase().replace('\-','')
if(!compressed || typeof unzip == 'undefined'){
    if(urlinfo['format']=='binary'){
        result["content"] = bufferHelper.toBuffer();
    }else{
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.downloader.prototype.refreshProxyList" id="apidoc.element.neocrawler.downloader.prototype.refreshProxyList">
        function <span class="apidocSignatureSpan">neocrawler.downloader.prototype.</span>refreshProxyList
        <span class="apidocSignatureSpan">(downloader)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">refreshProxyList = function (downloader){
    downloader.tmp_proxyList = [];
    downloader.getProxyListFromDb('proxy:vip:available:1s');
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
            break;
    }
});
this.redis_cli3 = redis.createClient(this.spiderCore.settings['proxy_info_redis_db'][1],this.spiderCore.settings['
;proxy_info_redis_db'][0]);
if(this.spiderCore.settings['use_proxy']){
    downloader.redis_cli3.select(downloader.spiderCore.settings['proxy_info_redis_db'][2], function(err,value) {
         if(err)throw(err);
         downloader.<span class="apidocCodeKeywordSpan">refreshProxyList</span>(downloader);
         downloader.on('refreshed_proxy_list',function(proxylist){
             downloader.spiderCore.emit('standby','downloader');
             setTimeout(function(){downloader.refreshProxyList(downloader)},10*60*1000);//refresh again after 10 mins
         });
     });

}else{
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.downloader.prototype.transCookieKvPair" id="apidoc.element.neocrawler.downloader.prototype.transCookieKvPair">
        function <span class="apidocSignatureSpan">neocrawler.downloader.prototype.</span>transCookieKvPair
        <span class="apidocSignatureSpan">(json)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">transCookieKvPair = function (json){
    var kvarray = [];
    for(var i=0; i&lt;json.length; i++){
        kvarray.push(json[i]['name']+'='+json[i]['value']);
    }
    return kvarray.join(';');
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
'headers': {
    "User-Agent":"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like NeoCrawler) Chrome/31.0.1650
.57 Safari/537.36",
    "Accept":"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",
    "Accept-Encoding":"gzip",
    "Accept-Language":"zh-CN,zh;q=0.8,en-US;q=0.6,en;q=0.4",
    "Referer":urlinfo['referer']||'',
    "void-proxy":urlinfo['void_proxy']?urlinfo['void_proxy']:"",
    "Cookie":this.<span class="apidocCodeKeywordSpan">transCookieKvPair</span>(urlinfo['cookie'])
}
    };
    logger.debug(util.format('Request start, %s',pageLink));
    var req = http.request(options, function(res) {
logger.debug(util.format('Response, %s',pageLink));

var result = {
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.extractor" id="apidoc.module.neocrawler.extractor">module neocrawler.extractor</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.extractor.extractor" id="apidoc.element.neocrawler.extractor.extractor">
        function <span class="apidocSignatureSpan">neocrawler.</span>extractor
        <span class="apidocSignatureSpan">(spiderCore)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">extractor = function (spiderCore){
    this.spiderCore = spiderCore;
    logger = spiderCore.settings.logger;
    this.cumulative_failure = 0;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.extractor.prototype" id="apidoc.module.neocrawler.extractor.prototype">module neocrawler.extractor.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.extractor.prototype.__getTopLevelDomain" id="apidoc.element.neocrawler.extractor.prototype.__getTopLevelDomain">
        function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>__getTopLevelDomain
        <span class="apidocSignatureSpan">(domain)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">__getTopLevelDomain = function (domain){
    if(!domain)return null;
    var arr = domain.split('.');
    if(arr.length&lt;=2)return domain;
    else return arr.slice(1).join('.');
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
 */
proxyRouter.prototype.proxyDaemon = function(){
var proxyRouter = this;
var httpProxyServer = http.createServer(function(request, response) {
    var timeOuter = false;
    var startTime = (new Date()).getTime();
    var urlobj = url.parse(request.url);
    var domain = proxyRouter.<span class="apidocCodeKeywordSpan">__getTopLevelDomain</span>(urlobj['hostname']);
    logger.info(util.format('Request %s from %s',request.url,request.socket.remoteAddress));
    //var proxy = http.createClient(80, request.headers['host']);
    //var proxy_request = proxy.request(request.method, request.url, request.headers);//202.171.253.98:80
    var route = true;
    proxyRouter.__chooseProxy(domain,request.socket.remoteAddress,request.headers,function(proxyAddr){
        if(route&amp;&amp;proxyAddr){
            var choseProxy = proxyAddr.split(':');
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.extractor.prototype.arrange_link" id="apidoc.element.neocrawler.extractor.prototype.arrange_link">
        function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>arrange_link
        <span class="apidocSignatureSpan">(links)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">arrange_link = function (links){
    var linkobj = {};
    for(var i=0;i&lt;links.length;i++){
        var link = links[i];
        var matched_driller = this.detectLink(link);
        if(matched_driller.length&gt;0){
            var driller_lib = 'urllib:' + matched_driller[0];
            var driller_rule = matched_driller[1];
            if(typeof(driller_rule)!='object')driller_rule = JSON.parse(driller_rule);
            if(linkobj[driller_lib]==undefined)linkobj[driller_lib]=[];
            if(driller_rule['id_parameter']&amp;&amp;driller_rule['id_parameter'].length&gt;0){
                var id_parameter = driller_rule['id_parameter'];
                var urlobj = url.parse(link);
                var parameters = querystring.parse(urlobj.query);
                var new_parameters = {};
                for(var x=0;x&lt;id_parameter.length;x++){
                    var param_name = id_parameter[x];
                    if(x==0&amp;&amp;param_name=='#')break;
                    if(parameters.hasOwnProperty(param_name))new_parameters[param_name] = parameters[param_name];
                }
                urlobj.search = querystring.stringify(new_parameters);
                link = url.format(urlobj);
            }
            linkobj[driller_lib].push(link);
        }
    }
    for(var i in linkobj){
        if(linkobj.hasOwnProperty(i)){
            linkobj[i] = arrayUnique(linkobj[i]);
        }
    }
    return linkobj;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    if(crawl_info['drill_link']){
        var drill_link = crawl_info['drill_link'];
    }else{
        var drill_link = this.extract_link($,crawl_info['origin']['drill_rules']);
    }

    var washed_link = this.wash_link(crawl_info['url'],drill_link);
    crawl_info['drill_link'] = this.<span class="apidocCodeKeywordSpan">arrange_link</span>(washed_link);
    if(this.spiderCore.settings['keep_link_relation'])crawl_info['drill_relation'] = this.getDrillRelation($,
crawl_info);
}

if(extract_rule['rule']&amp;&amp;!isEmpty(extract_rule['rule'])){
    var extracted_data = this.extract_data(crawl_info['url'],crawl_info['content'],extract_rule,null,$.root());
    crawl_info['extracted_data'] = extracted_data;
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.extractor.prototype.assembly" id="apidoc.element.neocrawler.extractor.prototype.assembly">
        function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>assembly
        <span class="apidocSignatureSpan">(callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">assembly = function (callback){
    if(callback)callback(null,'done');
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.extractor.prototype.checksublack" id="apidoc.element.neocrawler.extractor.prototype.checksublack">
        function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>checksublack
        <span class="apidocSignatureSpan">(keys, data)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">checksublack = function (keys, data){
    var sublackarr = [];
    for(var x=0;x&lt;keys.length;x++){
        if(!data[keys[x]]){
            sublackarr.push(keys[x]);
            logger.warn(keys[x] + ' not found in '+ url + ' extracted data');
        }
    }
    if(sublackarr.length===keys.length)return sublackarr;
    else return [];
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
        }
}
if(extract_rule['require']){
    var lacks = [];
    for(var c=0;c&lt;extract_rule['require'].length;c++){
        var key = extract_rule['require'][c];
        if(typeof(key)==='object'){
            var sublack = self.<span class="apidocCodeKeywordSpan">checksublack</span>(key,data);
            if(sublack.length&gt;0)lacks = lacks.concat(sublack);
        }else{
            if(!data[key]){
                lacks.push(key);
                logger.warn(key + ' not found in '+ url + ' extracted data');
            }
        }
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.extractor.prototype.cssSelector" id="apidoc.element.neocrawler.extractor.prototype.cssSelector">
        function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>cssSelector
        <span class="apidocSignatureSpan">($, expression, pick, index)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">cssSelector = function ($, expression, pick, index){
//    logger.debug('css expression: '+expression);
    if(!index)index=1;
    var real_index = parseInt(index) - 1;
    //if(real_index&lt;0)real_index=0;
    var tmp_val = $.find(expression);
    if(!pick)return tmp_val;
    if(typeof(tmp_val)==='object'){
        if(real_index&gt;=0){
            var val = tmp_val.eq(real_index);
            return this.cssSelectorPicker(val,pick);
        }else{
            var arrayResult = [];
            for(var i=0;i&lt;tmp_val.length;i++){
                var val = tmp_val.eq(i);
                arrayResult.push(this.cssSelectorPicker(val,pick));
            }
            if(arrayResult.length==1)arrayResult = arrayResult[0];
            return arrayResult;
        }
    }else {
        var val = tmp_val;
        return this.cssSelectorPicker(val,pick);
    }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
                    new_relation = this.regexSelector(crawl_info['url'],rule['expression'],rule['index&amp;#
x27;]);
                }else{
                    new_relation = this.regexSelector(crawl_info['content'],rule['expression'],rule['index
']);
                }
                break;
            case 'css':
            default:
                new_relation = this.<span class="apidocCodeKeywordSpan">cssSelector</span>($.root(),rule['expression'],
rule['pick'],rule['index']);
                break;
        }
    }
    return util.format('%s-&gt;%s',origin_relation,new_relation);
}

/**
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.extractor.prototype.cssSelectorPicker" id="apidoc.element.neocrawler.extractor.prototype.cssSelectorPicker">
        function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>cssSelectorPicker
        <span class="apidocSignatureSpan">(val, pick)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">cssSelectorPicker = function (val, pick){
    var result;
    if(pick.startsWith('@')){
        result = val.attr(pick.slice(1));
    }
    else{
        switch(pick.toLowerCase()){
            case 'text':
            case 'innertext':
                result = val.text();
                break;
            case 'html':
            case 'innerhtml':
                result = val.html();
                break;
        }
    }
    //if(result)result = result.replace(/[\r\n\t]/g, "").trim();
    if(result)result = result.trim();
    return result;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var real_index = parseInt(index) - 1;
//if(real_index&lt;0)real_index=0;
var tmp_val = $.find(expression);
if(!pick)return tmp_val;
if(typeof(tmp_val)==='object'){
    if(real_index&gt;=0){
        var val = tmp_val.eq(real_index);
        return this.<span class="apidocCodeKeywordSpan">cssSelectorPicker</span>(val,pick);
    }else{
        var arrayResult = [];
        for(var i=0;i&lt;tmp_val.length;i++){
            var val = tmp_val.eq(i);
            arrayResult.push(this.cssSelectorPicker(val,pick));
        }
        if(arrayResult.length==1)arrayResult = arrayResult[0];
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.extractor.prototype.detectLink" id="apidoc.element.neocrawler.extractor.prototype.detectLink">
        function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>detectLink
        <span class="apidocSignatureSpan">(link)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">detectLink = function (link){
    var urlobj = url.parse(link);
    var result = [];
    var domain = this.__getTopLevelDomain(urlobj['hostname']);
    if(domain &amp;&amp; this.spiderCore.spider.driller_rules[domain]!=undefined){
        var alias = this.spiderCore.spider.driller_rules[domain];
        for(a in alias){
            var url_pattern  = decodeURIComponent(alias[a]['url_pattern']);
            var patt = new RegExp(url_pattern);
            if(patt.test(link)){
                result = ['driller:'+domain+':'+a,alias[a]];
                break;
            }
        }

    }
    return result;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
 * @param links
 * @returns {{}}
 */
extractor.prototype.arrange_link = function(links){
var linkobj = {};
for(var i=0;i&lt;links.length;i++){
    var link = links[i];
    var matched_driller = this.<span class="apidocCodeKeywordSpan">detectLink</span>(link);
    if(matched_driller.length&gt;0){
        var driller_lib = 'urllib:' + matched_driller[0];
        var driller_rule = matched_driller[1];
        if(typeof(driller_rule)!='object')driller_rule = JSON.parse(driller_rule);
        if(linkobj[driller_lib]==undefined)linkobj[driller_lib]=[];
        if(driller_rule['id_parameter']&amp;&amp;driller_rule['id_parameter'].length&gt;0){
            var id_parameter = driller_rule['id_parameter'];
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.extractor.prototype.extract" id="apidoc.element.neocrawler.extractor.prototype.extract">
        function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>extract
        <span class="apidocSignatureSpan">(crawl_info)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">extract = function (crawl_info){
    if(crawl_info['origin']['format']=='binary')return crawl_info;
    var extract_rule = this.spiderCore.spider.getDrillerRule(crawl_info['origin']['urllib'],'extract_rule');

    if(crawl_info['origin']['drill_rules']||extract_rule['rule']){
        var $ = cheerio.load(crawl_info['content']);
    }

    if(crawl_info['origin']['drill_rules']){
        if(crawl_info['drill_link']){
            var drill_link = crawl_info['drill_link'];
        }else{
            var drill_link = this.extract_link($,crawl_info['origin']['drill_rules']);
        }

        var washed_link = this.wash_link(crawl_info['url'],drill_link);
        crawl_info['drill_link'] = this.arrange_link(washed_link);
        if(this.spiderCore.settings['keep_link_relation'])crawl_info['drill_relation'] = this.getDrillRelation($,crawl_info);
    }

    if(extract_rule['rule']&amp;&amp;!isEmpty(extract_rule['rule'])){
        var extracted_data = this.extract_data(crawl_info['url'],crawl_info['content'],extract_rule,null,$.root());
        crawl_info['extracted_data'] = extracted_data;
    }
    return crawl_info;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.extractor.prototype.extract_data" id="apidoc.element.neocrawler.extractor.prototype.extract_data">
        function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>extract_data
        <span class="apidocSignatureSpan">(url, content, extract_rule, uppper_data, dom)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">extract_data = function (url, content, extract_rule, uppper_data, dom){
    var data = {};
    var self = this;
    if(extract_rule['category'])data['$category'] = extract_rule['category'];
//    if(extract_rule['require'])data['$require'] = extract_rule['require'];
    if(extract_rule['relate'])data['relate'] = uppper_data[extract_rule['relate']];
    for(i in extract_rule['rule']){
        if(extract_rule['rule'].hasOwnProperty(i)){
            var rule = extract_rule['rule'][i];
            var baser = content;
            if(rule['base']==='url')baser = url;
            switch(rule['mode']){
                case 'regex':
                    var tmp_result = this.regexSelector(baser,rule['expression'],rule['index']);
                    data[i] = tmp_result;
                    break;
                case 'xpath':
                    break;
                case 'value':
                    data[i] = rule['expression'];
                    break;
                case 'json':
                    break;
                default://css selector
                    if(dom)baser = dom;
                    else baser = (cheerio.load(content)).root();
                    var pick = rule['pick'];
                    if(rule['subset']){
                        pick = false;
                        (function(k){
                            var result_arr = [];
                            var tmp_result = self.cssSelector(baser,rule['expression'],pick,rule['index']);
                            if(tmp_result){
                                tmp_result.each(function(x, elem) {
                                    var sub_dom = tmp_result.eq(x);
                                    result_arr.push(self.extract_data(url,content,rule['subset'],data,sub_dom));
                                });
                            }
                            if(!isEmpty(result_arr))data[k] = result_arr;
                        })(i);
                    }else{
                        try{
                            var tmp_result = this.cssSelector(baser,rule['expression'],pick,rule['index']);
                            if(tmp_result&amp;&amp;!isEmpty(tmp_result))data[i] = tmp_result;
                        } catch(e){
                            logger.error(url + ' extract field '+ i + ' error:'+e);
                        }
                    }

            }
            }
    }
    if(extract_rule['require']){
        var lacks = [];
        for(var c=0;c&lt;extract_rule['require'].length;c++){
            var key = extract_rule['require'][c];
            if(typeof(key)==='object'){
                var sublack = self.checksublack(key,data);
                if(sublack.length&gt;0)lacks = lacks.concat(sublack);
            }else{
                if(!data[key]){
                    lacks.push(key);
                    logger.warn(key + ' not found in '+ url + ' extracted data');
                }
            }
        }
        if(!isEmpty(lacks)){
            logger.error(url + ' extracted data lacks of '+lacks.join(','));
            self.spiderCore.spider.redis_cli2.zadd('incomplete:data:url',(new Date()).getTime(),url,function(err,result){
                //nothing
            });
            if('data_lack_alert' in self.spiderCore.spider_extend)self.spiderCore.spider_extend.data_lack_alert(url,lacks);
        }else{
            self.spiderCore.spider.redis_cli2.zrem('incomplete:data:url',url,function(err,result){
                //nothing
            });
        }
    }
    return data;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

       var washed_link = this.wash_link(crawl_info['url'],drill_link);
       crawl_info['drill_link'] = this.arrange_link(washed_link);
       if(this.spiderCore.settings['keep_link_relation'])crawl_info['drill_relation'] = this.getDrillRelation
($,crawl_info);
   }

   if(extract_rule['rule']&amp;&amp;!isEmpty(extract_rule['rule'])){
       var extracted_data = this.<span class="apidocCodeKeywordSpan">extract_data</span>(crawl_info['url'],crawl_info[&amp;#
x27;content'],extract_rule,null,$.root());
       crawl_info['extracted_data'] = extracted_data;
   }
   return crawl_info;
}
/**
* extract data
* @param url
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.extractor.prototype.extract_link" id="apidoc.element.neocrawler.extractor.prototype.extract_link">
        function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>extract_link
        <span class="apidocSignatureSpan">($, rules)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">extract_link = function ($, rules){
    var links = [];
    for(var i=0;i&lt;rules.length;i++){
        $(rules[i]).each(function(i, elem) {
            if(elem['name']=='img')links.push($(this).attr('src'));
	    else links.push($(this).attr('href'));
        });
    }
    return links;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    var $ = cheerio.load(crawl_info['content']);
}

if(crawl_info['origin']['drill_rules']){
    if(crawl_info['drill_link']){
        var drill_link = crawl_info['drill_link'];
    }else{
        var drill_link = this.<span class="apidocCodeKeywordSpan">extract_link</span>($,crawl_info['origin']['drill_rules
']);
    }

    var washed_link = this.wash_link(crawl_info['url'],drill_link);
    crawl_info['drill_link'] = this.arrange_link(washed_link);
    if(this.spiderCore.settings['keep_link_relation'])crawl_info['drill_relation'] = this.getDrillRelation($,
crawl_info);
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.extractor.prototype.getDrillRelation" id="apidoc.element.neocrawler.extractor.prototype.getDrillRelation">
        function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>getDrillRelation
        <span class="apidocSignatureSpan">($, crawl_info)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">getDrillRelation = function ($, crawl_info){
    //var rule = crawl_info['origin']['drill_relation_rule'];//rule: {"base":"content","mode":"css","expression":"#breadCrumb","
pick":"innerText","index":1}
    var rule = this.spiderCore.spider.getDrillerRule(crawl_info['origin']['urllib'],'drill_relation');
    var origin_relation = crawl_info['origin']['drill_relation'];
    if(!origin_relation)origin_relation = '*';
    var new_relation = '*';
    if(rule){
        switch(rule['mode']){
            case 'regex':
                if(rule['base']==='url'){
                    new_relation = this.regexSelector(crawl_info['url'],rule['expression'],rule['index']);
                }else{
                    new_relation = this.regexSelector(crawl_info['content'],rule['expression'],rule['index']);
                }
                break;
            case 'css':
            default:
                new_relation = this.cssSelector($.root(),rule['expression'],rule['pick'],rule['index']);
                break;
        }
    }
    return util.format('%s-&gt;%s',origin_relation,new_relation);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
        var drill_link = crawl_info['drill_link'];
    }else{
        var drill_link = this.extract_link($,crawl_info['origin']['drill_rules']);
    }

    var washed_link = this.wash_link(crawl_info['url'],drill_link);
    crawl_info['drill_link'] = this.arrange_link(washed_link);
    if(this.spiderCore.settings['keep_link_relation'])crawl_info['drill_relation'] = this.<span class="apidocCodeKeywordSpan
">getDrillRelation</span>($,crawl_info);
}

if(extract_rule['rule']&amp;&amp;!isEmpty(extract_rule['rule'])){
    var extracted_data = this.extract_data(crawl_info['url'],crawl_info['content'],extract_rule,null,$.root());
    crawl_info['extracted_data'] = extracted_data;
}
return crawl_info;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.extractor.prototype.regexSelector" id="apidoc.element.neocrawler.extractor.prototype.regexSelector">
        function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>regexSelector
        <span class="apidocSignatureSpan">(content, expression, index)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">regexSelector = function (content, expression, index){
    var index = parseInt(index);
    if(index==0)index=1;
    var expression = new RegExp(expression,"ig");
    if(index&gt;0){
        var matched = expression.exec(content);
        if(matched&amp;&amp;matched.length&gt;index)return matched[index];
    }else{
        var arr = [],matched;
        while (matched = expression.exec(content))
            arr.push(matched[1]);
        return arr;
    }

}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var origin_relation = crawl_info['origin']['drill_relation'];
if(!origin_relation)origin_relation = '*';
var new_relation = '*';
if(rule){
    switch(rule['mode']){
        case 'regex':
            if(rule['base']==='url'){
                new_relation = this.<span class="apidocCodeKeywordSpan">regexSelector</span>(crawl_info['url'],rule[&amp;#
x27;expression'],rule['index']);
            }else{
                new_relation = this.regexSelector(crawl_info['content'],rule['expression'],rule['index&amp;#
x27;]);
            }
            break;
        case 'css':
        default:
            new_relation = this.cssSelector($.root(),rule['expression'],rule['pick'],rule['index']);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.extractor.prototype.validateContent" id="apidoc.element.neocrawler.extractor.prototype.validateContent">
        function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>validateContent
        <span class="apidocSignatureSpan">(crawl_info)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">validateContent = function (crawl_info){
    var self = this;
    var result = true;
    var statusCode = parseInt(crawl_info['statusCode']);
    var limitation = 500;
    if(crawl_info['origin']['format']=='binary')limitation = 20;
    if(statusCode===200){
        if(crawl_info['content'].length&lt;limitation){
            logger.error(util.format('Too little content: %s, length:%s',crawl_info['url'],crawl_info['content'].length));
            result = false;
        }
        if(crawl_info['origin']['validation_keywords']){
            for(var i =0;i&lt;crawl_info['origin']['validation_keywords'].length;i++){
                var keyword = crawl_info['origin']['validation_keywords'][i];
                if(crawl_info['content'].indexOf(keyword)&lt;0){
                    logger.error(util.format('%s lacked keyword: %s',crawl_info['url'],keyword));
                    result = false;break;
                }
            }
        }
    }else{
        logger.error(util.format('url:%s, status code: %s',crawl_info['url'],statusCode));
        if(statusCode&gt;300)result=false;//30x,40x,50x
    }
    if(self.spiderCore.settings['to_much_fail_exit']){
        self.cumulative_failure +=  result?-1:1
        if(self.cumulative_failure&lt;0)self.cumulative_failure = 0;
        if(self.cumulative_failure&gt;self.spiderCore.settings['spider_concurrency']*1.5){
            logger.fatal('too much fail, exit. '+self.cumulative_failure);
            process.exit(1);
        }
    }
    return result;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.extractor.prototype.wash_link" id="apidoc.element.neocrawler.extractor.prototype.wash_link">
        function <span class="apidocSignatureSpan">neocrawler.extractor.prototype.</span>wash_link
        <span class="apidocSignatureSpan">(pageurl, links)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">wash_link = function (pageurl, links){
    //url resolve
    var cleaned_link = [];
    for(var i=0;i&lt;links.length;i++){
        if(!links[i])continue;
        var link = links[i].trim();
        if(!(link.startsWith('#')||link.startsWith('javascript')||link.startsWith('void('))){
            try{
                var the_url = url.resolve(pageurl,link);
                if(the_url!=pageurl)cleaned_link.push(the_url);
            }catch(e){
                logger.error('Url resolve error: '+pageurl+', '+link);
            }

        }
    }
    return arrayUnique(cleaned_link);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
if(crawl_info['origin']['drill_rules']){
    if(crawl_info['drill_link']){
        var drill_link = crawl_info['drill_link'];
    }else{
        var drill_link = this.extract_link($,crawl_info['origin']['drill_rules']);
    }

    var washed_link = this.<span class="apidocCodeKeywordSpan">wash_link</span>(crawl_info['url'],drill_link);
    crawl_info['drill_link'] = this.arrange_link(washed_link);
    if(this.spiderCore.settings['keep_link_relation'])crawl_info['drill_relation'] = this.getDrillRelation($,
crawl_info);
}

if(extract_rule['rule']&amp;&amp;!isEmpty(extract_rule['rule'])){
    var extracted_data = this.extract_data(crawl_info['url'],crawl_info['content'],extract_rule,null,$.root());
    crawl_info['extracted_data'] = extracted_data;
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.filter_list" id="apidoc.module.neocrawler.filter_list">module neocrawler.filter_list</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.filter_list.filter_list" id="apidoc.element.neocrawler.filter_list.filter_list">
        function <span class="apidocSignatureSpan">neocrawler.</span>filter_list
        <span class="apidocSignatureSpan">(operator, filter)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function FilterList(operator, filter) {
  var _ref;
  this.operator = operator;
  this.get = __bind(this.get, this);
  this.addFilter = __bind(this.addFilter, this);
  if ((_ref = this.operator) !== 'MUST_PASS_ALL' &amp;&amp; _ref !== 'MUST_PASS_ONE') {
    this.operator = 'MUST_PASS_ALL';
  }
  this.filters = [];
  if (filter) {
    filter = getFilter(filter);
    if (!filter) {
      return false;
    }
    this.filters.push(filter);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.filter_list.prototype" id="apidoc.module.neocrawler.filter_list.prototype">module neocrawler.filter_list.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.filter_list.prototype.addFilter" id="apidoc.element.neocrawler.filter_list.prototype.addFilter">
        function <span class="apidocSignatureSpan">neocrawler.filter_list.prototype.</span>addFilter
        <span class="apidocSignatureSpan">(filter)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">addFilter = function (filter) {
  filter = getFilter(filter);
  if (!filter) {
    return false;
  }
  return this.filters.push(filter);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.filter_list.prototype.get" id="apidoc.element.neocrawler.filter_list.prototype.get">
        function <span class="apidocSignatureSpan">neocrawler.filter_list.prototype.</span>get
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">get = function () {
  return {
    operator: this.operator,
    filters: this.filters
  };
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var redis_cli = function(host,port){
    this.ssdb_cli = SSDB.connect(host, port,30*1000,function(err,errobj){
        if(err)throw errobj;
    });
}

redis_cli.prototype.get = function(key,callback){
    this.ssdb_cli.<span class="apidocCodeKeywordSpan">get</span>(key,callback);
}

redis_cli.prototype.set = function(key,value,callback){
    this.ssdb_cli.set(key,value,callback);
}

redis_cli.prototype.expire = function(key,sec,callback){
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.gbk" id="apidoc.module.neocrawler.gbk">module neocrawler.gbk</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.gbk.dc_GBK" id="apidoc.element.neocrawler.gbk.dc_GBK">
        function <span class="apidocSignatureSpan">neocrawler.gbk.</span>dc_GBK
        <span class="apidocSignatureSpan">(arr)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">dc_GBK = function (arr){
	var kb = '',str="";
	for(var n = 0 , max = arr.length; n&lt;max ; n++){
		var Code = arr[n];
		if(Code &amp; 0x80){
			str += String.fromCharCode(ua[Code &lt;&lt; 8 | arr[++n]]);
		}else{
			str += String.fromCharCode(Code);
		}
	}
	return str;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    loc={};
if(lx == REDIRECT_MODE_1){//Country&nbsp;&nbsp;
    ipwz = setBuffer3(ipwz+1); //
    lx = ipFileBuffer.readUInt8(ipwz); //&nbsp;
    var Gjbut;
    if (lx == REDIRECT_MODE_2){//&nbsp;
        Gjbut = setIpFileString(setBuffer3(ipwz+1));
        loc.Country = GBK.<span class="apidocCodeKeywordSpan">dc_GBK</span>(Gjbut);
        ipwz = ipwz + 4;
    }else{
        Gjbut = setIpFileString(ipwz)
        loc.Country = GBK.dc_GBK(Gjbut);
        ipwz += Gjbut.length + 1;
    }
    loc.Area = ReadArea(ipwz);
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.get" id="apidoc.module.neocrawler.get">module neocrawler.get</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.get.get" id="apidoc.element.neocrawler.get.get">
        function <span class="apidocSignatureSpan">neocrawler.</span>get
        <span class="apidocSignatureSpan">(row)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Get(row) {
  this.row = row;
  this.getRow = __bind(this.getRow, this);
  this.getFields = __bind(this.getFields, this);
  this.setTimeRange = __bind(this.setTimeRange, this);
  this.setMaxVersions = __bind(this.setMaxVersions, this);
  this.addColumn = __bind(this.addColumn, this);
  this.tr = {
    from: null,
    to: null
  };
  this.familyMap = {};
  this.maxVersions = 1;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var redis_cli = function(host,port){
    this.ssdb_cli = SSDB.connect(host, port,30*1000,function(err,errobj){
        if(err)throw errobj;
    });
}

redis_cli.prototype.get = function(key,callback){
    this.ssdb_cli.<span class="apidocCodeKeywordSpan">get</span>(key,callback);
}

redis_cli.prototype.set = function(key,value,callback){
    this.ssdb_cli.set(key,value,callback);
}

redis_cli.prototype.expire = function(key,sec,callback){
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.get.prototype" id="apidoc.module.neocrawler.get.prototype">module neocrawler.get.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.get.prototype.addColumn" id="apidoc.element.neocrawler.get.prototype.addColumn">
        function <span class="apidocSignatureSpan">neocrawler.get.prototype.</span>addColumn
        <span class="apidocSignatureSpan">(cf, qualifier)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">addColumn = function (cf, qualifier) {
  var _base;
  if ((_base = this.familyMap)[cf] == null) {
    _base[cf] = [];
  }
  this.familyMap[cf].push(qualifier);
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.get.prototype.getFields" id="apidoc.element.neocrawler.get.prototype.getFields">
        function <span class="apidocSignatureSpan">neocrawler.get.prototype.</span>getFields
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">getFields = function () {
  var cf, o, qualifiers, _ref;
  o = {
    row: this.row,
    timeRange: this.tr,
    column: [],
    maxVersions: this.maxVersions
  };
  _ref = this.familyMap;
  for (cf in _ref) {
    qualifiers = _ref[cf];
    o.column = {
      family: cf,
      qualifier: qualifiers.map(function(qualifier) {
        return qualifier;
      })
    };
  }
  return o;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.get.prototype.getRow" id="apidoc.element.neocrawler.get.prototype.getRow">
        function <span class="apidocSignatureSpan">neocrawler.get.prototype.</span>getRow
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">getRow = function () {
  return this.row;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.get.prototype.setMaxVersions" id="apidoc.element.neocrawler.get.prototype.setMaxVersions">
        function <span class="apidocSignatureSpan">neocrawler.get.prototype.</span>setMaxVersions
        <span class="apidocSignatureSpan">(maxVersions)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">setMaxVersions = function (maxVersions) {
  if (maxVersions &lt;= 0) {
    maxVersions = 1;
  }
  this.maxVersions = maxVersions;
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.get.prototype.setTimeRange" id="apidoc.element.neocrawler.get.prototype.setTimeRange">
        function <span class="apidocSignatureSpan">neocrawler.get.prototype.</span>setTimeRange
        <span class="apidocSignatureSpan">(minStamp, maxStamp)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">setTimeRange = function (minStamp, maxStamp) {
  this.tr = {
    from: minStamp,
    to: maxStamp
  };
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.gfw_proxy" id="apidoc.module.neocrawler.gfw_proxy">module neocrawler.gfw_proxy</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.gfw_proxy.gfw_proxy" id="apidoc.element.neocrawler.gfw_proxy.gfw_proxy">
        function <span class="apidocSignatureSpan">neocrawler.</span>gfw_proxy
        <span class="apidocSignatureSpan">(settings)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">gfw_proxy = function (settings){
	events.EventEmitter.call(this);//eventemitter inherits
	this.settings = settings;
	logger = settings['logger'];
    this.handleCount = 0;//proxy handle count. once proxy list change, reset to 0.
    this.proxyServeMap = {};
    this.availableProxies = {};/*{domain:{$IP$:true}}*/
    this.resolvCache = {
        '192.168.72.11':false,
        '192.168.72.29':false,
        '192.168.72.34':false
    };
    this.dnsCache = {
        'backee':'10.1.1.122'
    };
    qqwry.info();
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.gfw_proxy.super_" id="apidoc.element.neocrawler.gfw_proxy.super_">
        function <span class="apidocSignatureSpan">neocrawler.gfw_proxy.</span>super_
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function EventEmitter() {
  EventEmitter.init.call(this);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.gfw_proxy.prototype" id="apidoc.module.neocrawler.gfw_proxy.prototype">module neocrawler.gfw_proxy.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.gfw_proxy.prototype.__chooseProxy" id="apidoc.element.neocrawler.gfw_proxy.prototype.__chooseProxy">
        function <span class="apidocSignatureSpan">neocrawler.gfw_proxy.prototype.</span>__chooseProxy
        <span class="apidocSignatureSpan">(domain, ip, header, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">__chooseProxy = function (domain, ip, header, callback){
    var proxyRouter = this;
    this.handleCount++;
    if(header['void-proxy']){
	logger.warn('Receive void proxy:'+header['void-proxy']);
        proxyRouter.__voteProxy(domain,header['void-proxy'],false);
        proxyRouter.__getProxyFromDb(domain,function(proxyAddr){
            callback(proxyAddr);
        });
    }
    if(header['client_pid']&amp;&amp;header['page']){
        var browserId = ip+':'+header['client_pid'];
        if(!this.proxyServeMap[browserId]||this.proxyServeMap[browserId][0]!==header['page']||!this.availableProxies[domain][this
.proxyServeMap[browserId][1]]){
            proxyRouter.__getProxyFromDb(domain,function(domain,proxyAddr){
                if(proxyAddr){
                    proxyRouter.proxyServeMap[browserId] = [header['page'],proxyAddr];
                }
                callback(proxyAddr);
            });
        }else {
            callback(this.proxyServeMap[browserId][1]);
        }
    }else{
        proxyRouter.__getProxyFromDb(domain,function(proxyAddr){
            callback(proxyAddr);
        });
    }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var startTime = (new Date()).getTime();
var urlobj = url.parse(request.url);
var domain = proxyRouter.__getTopLevelDomain(urlobj['hostname']);
logger.info(util.format('Request %s from %s',request.url,request.socket.remoteAddress));
//var proxy = http.createClient(80, request.headers['host']);
//var proxy_request = proxy.request(request.method, request.url, request.headers);//202.171.253.98:80
var route = true;
proxyRouter.<span class="apidocCodeKeywordSpan">__chooseProxy</span>(domain,request.socket.remoteAddress,request.headers,function
(proxyAddr){
    if(route&amp;&amp;proxyAddr){
        var choseProxy = proxyAddr.split(':');
        var remoteProxyHost = choseProxy[0];
        var remoteProxyPort = choseProxy[1];
        var proxy_request = http.request({'host':remoteProxyHost,'port':remoteProxyPort,'method':request
.method,'path':request.url,'headers':request.headers});
    }else{
        var proxy_request = http.request({'host':urlobj['host'],'port':urlobj['port'],&amp;#
x27;method':request.method,'path':request.url,'headers':request.headers});
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.gfw_proxy.prototype.__getProxyFromDb" id="apidoc.element.neocrawler.gfw_proxy.prototype.__getProxyFromDb">
        function <span class="apidocSignatureSpan">neocrawler.gfw_proxy.prototype.</span>__getProxyFromDb
        <span class="apidocSignatureSpan">(domain, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">__getProxyFromDb = function (domain, callback){
    var self = this;
    var proxyAddr;
    if(this.availableProxies[domain]){
        for(var k in this.availableProxies[domain]){
            if(this.availableProxies[domain].hasOwnProperty(k)){
                proxyAddr = k;
                logger.debug('get proxy '+k+' from cache '+domain);
                break;
            }
        }
    }
    if(proxyAddr)callback(proxyAddr);
    else{
        self.redis_cli3.lpop(PROXY_KEYS,function(err,ip){
            if(err)logger.error('Encountered error pop proxy from redis: '+err);
            else logger.debug('get proxy '+ip+' from redis ');
            callback(ip);
        });
    }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
 */
proxyRouter.prototype.__chooseProxy = function(domain,ip,header,callback){
var proxyRouter = this;
this.handleCount++;
if(header['void-proxy']){
	logger.warn('Receive void proxy:'+header['void-proxy']);
    proxyRouter.__voteProxy(domain,header['void-proxy'],false);
    proxyRouter.<span class="apidocCodeKeywordSpan">__getProxyFromDb</span>(domain,function(proxyAddr){
        callback(proxyAddr);
    });
}
if(header['client_pid']&amp;&amp;header['page']){
    var browserId = ip+':'+header['client_pid'];
    if(!this.proxyServeMap[browserId]||this.proxyServeMap[browserId][0]!==header['page']||!this.availableProxies[domain
][this.proxyServeMap[browserId][1]]){
        proxyRouter.__getProxyFromDb(domain,function(domain,proxyAddr){
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.gfw_proxy.prototype.__getTopLevelDomain" id="apidoc.element.neocrawler.gfw_proxy.prototype.__getTopLevelDomain">
        function <span class="apidocSignatureSpan">neocrawler.gfw_proxy.prototype.</span>__getTopLevelDomain
        <span class="apidocSignatureSpan">(domain)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">__getTopLevelDomain = function (domain){
    var arr = domain.split('.');
    if(arr.length&lt;=2)return domain;
    else return arr.slice(1).join('.');
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
 */
proxyRouter.prototype.proxyDaemon = function(){
var proxyRouter = this;
var httpProxyServer = http.createServer(function(request, response) {
    var timeOuter = false;
    var startTime = (new Date()).getTime();
    var urlobj = url.parse(request.url);
    var domain = proxyRouter.<span class="apidocCodeKeywordSpan">__getTopLevelDomain</span>(urlobj['hostname']);
    logger.info(util.format('Request %s from %s',request.url,request.socket.remoteAddress));
    //var proxy = http.createClient(80, request.headers['host']);
    //var proxy_request = proxy.request(request.method, request.url, request.headers);//202.171.253.98:80
    var route = true;
    proxyRouter.__chooseProxy(domain,request.socket.remoteAddress,request.headers,function(proxyAddr){
        if(route&amp;&amp;proxyAddr){
            var choseProxy = proxyAddr.split(':');
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.gfw_proxy.prototype.__voteProxy" id="apidoc.element.neocrawler.gfw_proxy.prototype.__voteProxy">
        function <span class="apidocSignatureSpan">neocrawler.gfw_proxy.prototype.</span>__voteProxy
        <span class="apidocSignatureSpan">(domain, ip, score, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">__voteProxy = function (domain, ip, score, callback){
    var self = this;
    if(!self.availableProxies[domain])self.availableProxies[domain] = {};
    if(score&amp;&amp;ip){
        if(self.availableProxies[domain][ip]){
            logger.debug('Vote '+ip+' available to cache, '+domain);
            if(callback)callback();
        }else {
            self.availableProxies[domain][ip] = true;
            self.redis_cli3.lpush(PROXY_KEYS,ip,function(err){
                if(err)logger.error('Encountered error vote proxy to redis');
                else logger.info('Vote '+ip+' available to redis, '+domain);
                if(callback)callback(err);
            });
        }
    }else{
        if(ip)delete self.availableProxies[domain][ip];
        logger.warn('Vote '+ip+' not available');
        if(callback)callback();
    }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
 * @private
 */
proxyRouter.prototype.__chooseProxy = function(domain,ip,header,callback){
var proxyRouter = this;
this.handleCount++;
if(header['void-proxy']){
	logger.warn('Receive void proxy:'+header['void-proxy']);
    proxyRouter.<span class="apidocCodeKeywordSpan">__voteProxy</span>(domain,header['void-proxy'],false);
    proxyRouter.__getProxyFromDb(domain,function(proxyAddr){
        callback(proxyAddr);
    });
}
if(header['client_pid']&amp;&amp;header['page']){
    var browserId = ip+':'+header['client_pid'];
    if(!this.proxyServeMap[browserId]||this.proxyServeMap[browserId][0]!==header['page']||!this.availableProxies[domain
][this.proxyServeMap[browserId][1]]){
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.gfw_proxy.prototype.ipInChina" id="apidoc.element.neocrawler.gfw_proxy.prototype.ipInChina">
        function <span class="apidocSignatureSpan">neocrawler.gfw_proxy.prototype.</span>ipInChina
        <span class="apidocSignatureSpan">(ip)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">ipInChina = function (ip){
    var ipL = qqwry.searchIP(ip);
    var inChina = true;
    if(ipL) {
        logger.debug(JSON.stringify(ipL));
        if (ipL['Country'].startsWith('') ||
            ipL['Country'].startsWith('') ||
            ipL['Country'].startsWith('') ||
            ipL['Country'].startsWith('') ||
            ipL['Country'].startsWith('') ||
            ipL['Country'].startsWith('&nbsp;') ||
            ipL['Country'].startsWith('') ||
            ipL['Country'].startsWith('') ||
            ipL['Country'].startsWith('') ||
            ipL['Country'].startsWith('') ||
            ipL['Country'].startsWith('')
            )inChina = false;
    }
    logger.debug(ip+' in China? '+inChina);
    return inChina;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var self = this;
if(this.resolvCache.hasOwnProperty(hostname)){
    callback(this.resolvCache[hostname]);
}else{
    if(/^[\d\.]+$/.test(hostname)){
        if(hostname.startsWith('192.168')||hostname.startsWith('10.1'))callback(false);
        else{
            var isInChina = this.<span class="apidocCodeKeywordSpan">ipInChina</span>(hostname);
            this.resolvCache[hostname] = isInChina?false:true;
            callback(isInChina?false:true);
        }
    }else{
        if(this.dnsCache[hostname]){
            var address = this.dnsCache[hostname];
            if(address.startsWith('192.168')||address.startsWith('10.1'))callback(false);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.gfw_proxy.prototype.needProxy" id="apidoc.element.neocrawler.gfw_proxy.prototype.needProxy">
        function <span class="apidocSignatureSpan">neocrawler.gfw_proxy.prototype.</span>needProxy
        <span class="apidocSignatureSpan">(hostname, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">needProxy = function (hostname, callback){
    var self = this;
    if(this.resolvCache.hasOwnProperty(hostname)){
        callback(this.resolvCache[hostname]);
    }else{
        if(/^[\d\.]+$/.test(hostname)){
            if(hostname.startsWith('192.168')||hostname.startsWith('10.1'))callback(false);
            else{
                var isInChina = this.ipInChina(hostname);
                this.resolvCache[hostname] = isInChina?false:true;
                callback(isInChina?false:true);
            }
        }else{
            if(this.dnsCache[hostname]){
                var address = this.dnsCache[hostname];
                if(address.startsWith('192.168')||address.startsWith('10.1'))callback(false);
                else{
                    var isInChina = this.ipInChina(address);
                    this.resolvCache[hostname] = isInChina?false:true;
                    callback(isInChina?false:true);
                }
            }else{
                dns.resolve4(hostname,function(err,addresses){
                    if(err||!addresses){
                        console.error(err);
                        callback(true);
                    }else {
                        self.dnsCache[hostname] = addresses[0];
                        if(addresses[0].startsWith('192.168')||addresses[0].startsWith('10.1'))callback(false);
                        else{
                            var isInChina = self.ipInChina(addresses[0]);
                            self.resolvCache[hostname] = isInChina?false:true;
                            callback(isInChina?false:true);
                        }
                    }
                });
            }
        }
    }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var startTime = (new Date()).getTime();
var urlobj = url.parse(request.url);
var domain = proxyRouter.__getTopLevelDomain(urlobj['hostname']);
logger.info(util.format('Request %s from %s',request.url,request.socket.remoteAddress));
//var proxy = http.createClient(80, request.headers['host']);
//var proxy_request = proxy.request(request.method, request.url, request.headers);//202.171.253.98:80
var route = true;
proxyRouter.<span class="apidocCodeKeywordSpan">needProxy</span>(urlobj['hostname'],function(bol){
    route = bol;
    logger.debug(urlobj['hostname']+' need proxy: '+route);
    proxyRouter.__chooseProxy(domain,request.socket.remoteAddress,request.headers,function(proxyAddr){
        if(route&amp;&amp;proxyAddr){
            var choseProxy = proxyAddr.split(':');
            var remoteProxyHost = choseProxy[0];
            var remoteProxyPort = choseProxy[1];
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.gfw_proxy.prototype.proxyDaemon" id="apidoc.element.neocrawler.gfw_proxy.prototype.proxyDaemon">
        function <span class="apidocSignatureSpan">neocrawler.gfw_proxy.prototype.</span>proxyDaemon
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">proxyDaemon = function (){
    var proxyRouter = this;
    var httpProxyServer = http.createServer(function(request, response) {
        var timeOuter = false;
        var startTime = (new Date()).getTime();
        var urlobj = url.parse(request.url);
        var domain = proxyRouter.__getTopLevelDomain(urlobj['hostname']);
        logger.info(util.format('Request %s from %s',request.url,request.socket.remoteAddress));
        //var proxy = http.createClient(80, request.headers['host']);
        //var proxy_request = proxy.request(request.method, request.url, request.headers);//202.171.253.98:80
        var route = true;
        proxyRouter.needProxy(urlobj['hostname'],function(bol){
            route = bol;
            logger.debug(urlobj['hostname']+' need proxy: '+route);
            proxyRouter.__chooseProxy(domain,request.socket.remoteAddress,request.headers,function(proxyAddr){
                if(route&amp;&amp;proxyAddr){
                    var choseProxy = proxyAddr.split(':');
                    var remoteProxyHost = choseProxy[0];
                    var remoteProxyPort = choseProxy[1];
                    var proxy_request = http.request({'host':remoteProxyHost,'port':remoteProxyPort,'method':request.method,'path
':request.url,'headers':request.headers});
                }else{
                    var proxy_request = http.request({'host':urlobj['host'],'port':urlobj['port'],'method':request.method,'path':
request.url,'headers':request.headers});
                }
                //--proxy start---------------------------
                //proxy_request.setSocketKeepAlive(false);
                proxy_request.setTimeout(120000,function(){
                    logger.error('Remote request timeout.'+request.url);
                    proxy_request.abort();
                    response.end();
                });

                var timer_start = (new Date()).getTime();
                logger.debug(util.format('Request(%s) Forward to remote proxy server %s:%s',request.url,remoteProxyHost,remoteProxyPort
));
                var remote_proxy_response = null;
                proxy_request.addListener('response', function (proxy_response) {
                    remote_proxy_response = proxy_response;
                    proxyRouter.__voteProxy(domain,proxyAddr,parseInt(proxy_response.statusCode)&lt;400);//vote proxy//flex mode
                    proxy_response.addListener('data', function(chunk) {
                        //logger.debug('Write data to client');
                        if(!response.socket||response.socket.destroyed){
                            logger.error('client socket closed,oop! '+request.url);
                            response.end();
                            proxy_response.socket.destroy();
                            proxy_request.abort();
                            if(timeOuter){
                                clearTimeout(timeOuter);
                                timeOuter = false;
                            }
                        }else response.write(chunk, 'binary');
                    });

                    proxy_response.addListener('end', function() {
                        response.end();
                        logger.info(util.format('Write data to client(%s) finish, used proxy: %s, cost: %s ms, url: %s',request.
socket.remoteAddress,route?proxyAddr:'none',(new Date()).getTime()-startTime,request.url));
                        remote_proxy_response = null;//reset
                        if(timeOuter){
                            clearTimeout(timeOuter);
                            timeOuter = false;
                        }
                    });

                    proxy_response.headers['remoteproxy'] = util.format('%s:%d',remoteProxyHost,remoteProxyPort);
                    response.writeHead(proxy_response.statusCode, proxy_response.headers);
                    //response.write(util.format('&lt;!--%s:%d--&gt;',remoteProxyHost,remoteProxyPort), 'binary');
                    logger.debug(util.format('Remote proxy response, %d, leng ...</pre></li>
    <li>example usage<pre class="apidocCodePre">...
   myredis.createClient(
       self.settings['proxy_info_redis_db'][0],
       self.settings['proxy_info_redis_db'][1],
       self.settings['proxy_info_redis_db'][2],
       dbtype,
       function(err,cli){
           self.redis_cli3 = cli;
           self.<span class="apidocCodeKeywordSpan">proxyDaemon</span>();
       });
}

/**
* TOP Domain,e.g: www.baidu.com  -&gt; baidu.com
* @param domain
* @returns {*}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.gfw_proxy.prototype.start" id="apidoc.element.neocrawler.gfw_proxy.prototype.start">
        function <span class="apidocSignatureSpan">neocrawler.gfw_proxy.prototype.</span>start
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">start = function (){
    var self = this;
    var dbtype = 'redis';
    if(self.settings['use_ssdb'])dbtype = 'ssdb';
    myredis.createClient(
        self.settings['proxy_info_redis_db'][0],
        self.settings['proxy_info_redis_db'][1],
        self.settings['proxy_info_redis_db'][2],
        dbtype,
        function(err,cli){
            self.redis_cli3 = cli;
            self.proxyDaemon();
        });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
);
var logger = log4js.getLogger('shuttle');
logger.setLevel('DEBUG');
settings['logger'] = logger;
settings['port'] = 1985;
var gfw_proxy = new (require('./gfw-proxy.js'))(settings);

gfw_proxy.<span class="apidocCodeKeywordSpan">start</span>();
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.httpRequest" id="apidoc.module.neocrawler.httpRequest">module neocrawler.httpRequest</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.httpRequest.cssExtract" id="apidoc.element.neocrawler.httpRequest.cssExtract">
        function <span class="apidocSignatureSpan">neocrawler.httpRequest.</span>cssExtract
        <span class="apidocSignatureSpan">(content, expression, pick, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">cssExtract = function (content, expression, pick, callback){
    if(typeof content=='string')var $ = (cheerio.load(content)).root();
    else var $ = content;
    var tmp_val = $.find(expression);
    var val = tmp_val.eq(0);
    var result;
    if(pick.startsWith('@')){
        result = val.attr(pick.slice(1));
    }
    else{
        switch(pick.toLowerCase()){
            case 'text':
            case 'innertext':
                result = val.text();
                break;
            case 'html':
            case 'innerhtml':
                result = val.html();
                break;
        }
    }
    //if(result)result = result.replace(/[\r\n\t]/g, "").trim();
    if(result)result = result.trim();
    return result;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.httpRequest.getDom" id="apidoc.element.neocrawler.httpRequest.getDom">
        function <span class="apidocSignatureSpan">neocrawler.httpRequest.</span>getDom
        <span class="apidocSignatureSpan">(content)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">getDom = function (content){
    return (cheerio.load(content)).root();
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.httpRequest.regexExtract" id="apidoc.element.neocrawler.httpRequest.regexExtract">
        function <span class="apidocSignatureSpan">neocrawler.httpRequest.</span>regexExtract
        <span class="apidocSignatureSpan">(content, expression, index)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">regexExtract = function (content, expression, index){
    var index = parseInt(index);
    if(index==0)index=1;
    var expression = new RegExp(expression,"ig");
    if(index&gt;0){
        var matched = expression.exec(content);
        if(matched&amp;&amp;matched.length&gt;index)return matched[index];
    }else{
        var arr = [],matched;
        while (matched = expression.exec(content))
            arr.push(matched[1]);
        return arr;
    }

}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.httpRequest.request" id="apidoc.element.neocrawler.httpRequest.request">
        function <span class="apidocSignatureSpan">neocrawler.httpRequest.</span>request
        <span class="apidocSignatureSpan">(url, referer, cookie, proxy, timeout, isbin, callback, param)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">request = function (url, referer, cookie, proxy, timeout, isbin, callback, param){
    var timeOuter = false;
    var callbackCount = 0;
    if(proxy){
        var proxyRouter = proxy.split(':');
        var __host = proxyRouter[0];
        var __port = proxyRouter[1];
        var __path =  url;
    }else{
        var urlobj = urlUtil.parse(url);
        var __host = urlobj['hostname'];
        var __port = urlobj['port'];
        var __path = urlobj['path'];
    }
    var startTime = new Date();
    var options = {
        'host': __host,
        'port': __port,
        'path': __path,
        'method': 'GET',
        'headers': {
            "User-Agent":"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.57 Safari/
537.36",
            "Accept":"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",
            //"Accept-Encoding":"gzip,deflate,sdch",
            "Accept-Encoding":"gzip",
            "Accept-Language":"zh-CN,zh;q=0.8,en-US;q=0.6,en;q=0.4"
        }
    };

    if(cookie){
        var cookie_kvarray = [];
        for(var i=0; i&lt;cookie.length; i++){
            cookie_kvarray.push(cookie[i]['name']+'='+cookie[i]['value']);
        }
        var cookies_str = cookie_kvarray.join(';');
        if(cookies_str.length&gt;0)options['headers']['Cookie'] = cookies_str;
    }

    if(referer)options['headers']['Referer'] = referer;

    var req = http.request(options, function(res) {
        if(res.statusCode==301||res.statusCode==302){
            if(res.headers['location']){
                return request(res.headers['location'],referer,cookie,proxy,timeout,isbin,callback,param);
            }
        }

        var bufferHelper = new BufferHelper();

//        res.setEncoding('utf8');

        res.on('data', function (chunk) {
            bufferHelper.concat(chunk);
        });

        res.on('end', function () {
            //console.log('Response end, '+url+' use proxy: '+proxy);
            if(timeOuter){
                clearTimeout(timeOuter);
                timeOuter = false;
            }
            if(!req)return callback(new Error('time out'),504,null,null,param||callbackCount++);
            req = null;

            var page_encoding = get_page_encoding(res.headers);

            page_encoding = page_encoding.toLowerCase().replace('\-','');

            var res_encoding = res.headers['content-encoding'];
            if (res_encoding == 'gzip' &amp;&amp; typeof unzip != 'undefined') {
                unzip(bufferHelper.toBuffer(), function(err, buff) {
                    if (!err &amp;&amp; buff) {
                        if(isbin){if(callbackCount&lt;1)callback(null,res.statusCode,buff,page_encoding,param||callbackCount++);}
                        else {if(callbackCount&lt;1)callback(null,res.statusCode,iconv.decode(buff,page_encoding),page_encoding,param
||callbackCount++);}
                    }else {if(callbackCount&lt;1)callback(new Error('gzip no content '+err),res.statusCode,null,page_encoding,param
||callbackCount++);}
                });
            } else if (res_encoding == 'deflate' &amp;&amp; typeof inflate != 'undefined') {
                inflate(bufferHelper.toBuffer(), function(err, buff) {
                    if (!err &amp;&amp; buff) {
                        if(isbin){if(callbackCount&lt;1)callback(null,res.statusCode,buff,page_encoding,param||callbackCount++);}
                        else {if(callbackCount&lt;1)callback(null,res.statusCode,iconv.decode(buff,page_encoding),page_encoding,param
||callbackCount++);}
                    }else {if(callbackCount&lt;1)callback(new Error('deflate no content '+err),res.statusCode,null,page_encoding,param
||callbackCount++);}
                });
            } else {
                if(isbin){if(callbackCount&lt;1)callback(null,res.statusCode,bufferHelper.toBuffer(),page_encoding,param||callbackCount
++);}
                else {if(callbackCount&lt;1)callback(null,res.statusCode,iconv.decode(bufferHelper.toBuffer(),page_encoding),page_encoding
,param||callbackCount++);}
            }
        });
    });

    timeOuter = setTimeout(function(){ ...</pre></li>
    <li>example usage<pre class="apidocCodePre">...
}
var cookies_str = cookie_kvarray.join(';');
if(cookies_str.length&gt;0)options['headers']['Cookie'] = cookies_str;
    }

    if(referer)options['headers']['Referer'] = referer;

    var req = http.<span class="apidocCodeKeywordSpan">request</span>(options, function(res) {
if(res.statusCode==301||res.statusCode==302){
    if(res.headers['location']){
        return request(res.headers['location'],referer,cookie,proxy,timeout,isbin,callback,param);
    }
}

var bufferHelper = new BufferHelper();
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.index" id="apidoc.module.neocrawler.index">module neocrawler.index</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.index.index" id="apidoc.element.neocrawler.index.index">
        function <span class="apidocSignatureSpan">neocrawler.</span>index
        <span class="apidocSignatureSpan">(settings)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">index = function (settings){
	events.EventEmitter.call(this);//eventemitter inherits
	this.settings = settings;
	logger = settings['logger'];
    this.handleCount = 0;//proxy handle count. once proxy list change, reset to 0.
    this.proxyServeMap = {};
    this.availableProxies = {};/*{domain:{$IP$:true}}*/
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.index.super_" id="apidoc.element.neocrawler.index.super_">
        function <span class="apidocSignatureSpan">neocrawler.index.</span>super_
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function EventEmitter() {
  EventEmitter.init.call(this);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.index.prototype" id="apidoc.module.neocrawler.index.prototype">module neocrawler.index.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.index.prototype.__chooseProxy" id="apidoc.element.neocrawler.index.prototype.__chooseProxy">
        function <span class="apidocSignatureSpan">neocrawler.index.prototype.</span>__chooseProxy
        <span class="apidocSignatureSpan">(domain, ip, header, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">__chooseProxy = function (domain, ip, header, callback){
    var proxyRouter = this;
    this.handleCount++;
    if(header['void-proxy']){
	logger.warn('Receive void proxy:'+header['void-proxy']);
        proxyRouter.__voteProxy(domain,header['void-proxy'],false);
        proxyRouter.__getProxyFromDb(domain,function(proxyAddr){
            callback(proxyAddr);
        });
    }
    if(header['client_pid']&amp;&amp;header['page']){
        var browserId = ip+':'+header['client_pid'];
        if(!this.proxyServeMap[browserId]||this.proxyServeMap[browserId][0]!==header['page']||!this.availableProxies[domain][this
.proxyServeMap[browserId][1]]){
            proxyRouter.__getProxyFromDb(domain,function(domain,proxyAddr){
                if(proxyAddr){
                    proxyRouter.proxyServeMap[browserId] = [header['page'],proxyAddr];
                }
                callback(proxyAddr);
            });
        }else {
            callback(this.proxyServeMap[browserId][1]);
        }
    }else{
        proxyRouter.__getProxyFromDb(domain,function(proxyAddr){
            callback(proxyAddr);
        });
    }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var startTime = (new Date()).getTime();
var urlobj = url.parse(request.url);
var domain = proxyRouter.__getTopLevelDomain(urlobj['hostname']);
logger.info(util.format('Request %s from %s',request.url,request.socket.remoteAddress));
//var proxy = http.createClient(80, request.headers['host']);
//var proxy_request = proxy.request(request.method, request.url, request.headers);//202.171.253.98:80
var route = true;
proxyRouter.<span class="apidocCodeKeywordSpan">__chooseProxy</span>(domain,request.socket.remoteAddress,request.headers,function
(proxyAddr){
    if(route&amp;&amp;proxyAddr){
        var choseProxy = proxyAddr.split(':');
        var remoteProxyHost = choseProxy[0];
        var remoteProxyPort = choseProxy[1];
        var proxy_request = http.request({'host':remoteProxyHost,'port':remoteProxyPort,'method':request
.method,'path':request.url,'headers':request.headers});
    }else{
        var proxy_request = http.request({'host':urlobj['host'],'port':urlobj['port'],&amp;#
x27;method':request.method,'path':request.url,'headers':request.headers});
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.index.prototype.__getProxyFromDb" id="apidoc.element.neocrawler.index.prototype.__getProxyFromDb">
        function <span class="apidocSignatureSpan">neocrawler.index.prototype.</span>__getProxyFromDb
        <span class="apidocSignatureSpan">(domain, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">__getProxyFromDb = function (domain, callback){
    var self = this;
    var proxyAddr;
    if(this.availableProxies[domain]){
        for(var k in this.availableProxies[domain]){
            if(this.availableProxies[domain].hasOwnProperty(k)){
                proxyAddr = k;
                logger.debug('get proxy '+k+' from cache '+domain);
                break;
            }
        }
    }
    if(proxyAddr)callback(proxyAddr);
    else{
        self.redis_cli3.lpop(PROXY_KEYS,function(err,ip){
            if(err)logger.error('Encountered error pop proxy from redis: '+err);
            else logger.debug('get proxy '+ip+' from redis ');
            callback(ip);
        });
    }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
 */
proxyRouter.prototype.__chooseProxy = function(domain,ip,header,callback){
var proxyRouter = this;
this.handleCount++;
if(header['void-proxy']){
	logger.warn('Receive void proxy:'+header['void-proxy']);
    proxyRouter.__voteProxy(domain,header['void-proxy'],false);
    proxyRouter.<span class="apidocCodeKeywordSpan">__getProxyFromDb</span>(domain,function(proxyAddr){
        callback(proxyAddr);
    });
}
if(header['client_pid']&amp;&amp;header['page']){
    var browserId = ip+':'+header['client_pid'];
    if(!this.proxyServeMap[browserId]||this.proxyServeMap[browserId][0]!==header['page']||!this.availableProxies[domain
][this.proxyServeMap[browserId][1]]){
        proxyRouter.__getProxyFromDb(domain,function(domain,proxyAddr){
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.index.prototype.__getTopLevelDomain" id="apidoc.element.neocrawler.index.prototype.__getTopLevelDomain">
        function <span class="apidocSignatureSpan">neocrawler.index.prototype.</span>__getTopLevelDomain
        <span class="apidocSignatureSpan">(domain)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">__getTopLevelDomain = function (domain){
    var arr = domain.split('.');
    if(arr.length&lt;=2)return domain;
    else return arr.slice(1).join('.');
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
 */
proxyRouter.prototype.proxyDaemon = function(){
var proxyRouter = this;
var httpProxyServer = http.createServer(function(request, response) {
    var timeOuter = false;
    var startTime = (new Date()).getTime();
    var urlobj = url.parse(request.url);
    var domain = proxyRouter.<span class="apidocCodeKeywordSpan">__getTopLevelDomain</span>(urlobj['hostname']);
    logger.info(util.format('Request %s from %s',request.url,request.socket.remoteAddress));
    //var proxy = http.createClient(80, request.headers['host']);
    //var proxy_request = proxy.request(request.method, request.url, request.headers);//202.171.253.98:80
    var route = true;
    proxyRouter.__chooseProxy(domain,request.socket.remoteAddress,request.headers,function(proxyAddr){
        if(route&amp;&amp;proxyAddr){
            var choseProxy = proxyAddr.split(':');
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.index.prototype.__voteProxy" id="apidoc.element.neocrawler.index.prototype.__voteProxy">
        function <span class="apidocSignatureSpan">neocrawler.index.prototype.</span>__voteProxy
        <span class="apidocSignatureSpan">(domain, ip, score, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">__voteProxy = function (domain, ip, score, callback){
    var self = this;
    if(!self.availableProxies[domain])self.availableProxies[domain] = {};
    if(score&amp;&amp;ip){
        if(self.availableProxies[domain][ip]){
            logger.debug('Vote '+ip+' available to cache, '+domain);
            if(callback)callback();
        }else {
            self.availableProxies[domain][ip] = true;
            self.redis_cli3.lpush(PROXY_KEYS,ip,function(err){
                if(err)logger.error('Encountered error vote proxy to redis');
                else logger.info('Vote '+ip+' available to redis, '+domain);
                if(callback)callback(err);
            });
        }
    }else{
        if(ip)delete self.availableProxies[domain][ip];
        logger.warn('Vote '+ip+' not available');
        if(callback)callback();
    }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
 * @private
 */
proxyRouter.prototype.__chooseProxy = function(domain,ip,header,callback){
var proxyRouter = this;
this.handleCount++;
if(header['void-proxy']){
	logger.warn('Receive void proxy:'+header['void-proxy']);
    proxyRouter.<span class="apidocCodeKeywordSpan">__voteProxy</span>(domain,header['void-proxy'],false);
    proxyRouter.__getProxyFromDb(domain,function(proxyAddr){
        callback(proxyAddr);
    });
}
if(header['client_pid']&amp;&amp;header['page']){
    var browserId = ip+':'+header['client_pid'];
    if(!this.proxyServeMap[browserId]||this.proxyServeMap[browserId][0]!==header['page']||!this.availableProxies[domain
][this.proxyServeMap[browserId][1]]){
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.index.prototype.proxyDaemon" id="apidoc.element.neocrawler.index.prototype.proxyDaemon">
        function <span class="apidocSignatureSpan">neocrawler.index.prototype.</span>proxyDaemon
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">proxyDaemon = function (){
    var proxyRouter = this;
    var httpProxyServer = http.createServer(function(request, response) {
        var timeOuter = false;
        var startTime = (new Date()).getTime();
        var urlobj = url.parse(request.url);
        var domain = proxyRouter.__getTopLevelDomain(urlobj['hostname']);
        logger.info(util.format('Request %s from %s',request.url,request.socket.remoteAddress));
        //var proxy = http.createClient(80, request.headers['host']);
        //var proxy_request = proxy.request(request.method, request.url, request.headers);//202.171.253.98:80
        var route = true;
        proxyRouter.__chooseProxy(domain,request.socket.remoteAddress,request.headers,function(proxyAddr){
            if(route&amp;&amp;proxyAddr){
                var choseProxy = proxyAddr.split(':');
                var remoteProxyHost = choseProxy[0];
                var remoteProxyPort = choseProxy[1];
                var proxy_request = http.request({'host':remoteProxyHost,'port':remoteProxyPort,'method':request.method,'path':request
.url,'headers':request.headers});
            }else{
                var proxy_request = http.request({'host':urlobj['host'],'port':urlobj['port'],'method':request.method,'path':request
.url,'headers':request.headers});
            }
            //--proxy start---------------------------
            //proxy_request.setSocketKeepAlive(false);
            proxy_request.setTimeout(120000,function(){
                logger.error('Remote request timeout.'+request.url);
                proxy_request.abort();
                response.end();
            });

            var timer_start = (new Date()).getTime();
            logger.debug(util.format('Request(%s) Forward to remote proxy server %s:%s',request.url,remoteProxyHost,remoteProxyPort
));
            var remote_proxy_response = null;
            proxy_request.addListener('response', function (proxy_response) {
                remote_proxy_response = proxy_response;
                proxyRouter.__voteProxy(domain,proxyAddr,parseInt(proxy_response.statusCode)&lt;400);//vote proxy//flex mode
                proxy_response.addListener('data', function(chunk) {
                    //logger.debug('Write data to client');
                    if(!response.socket||response.socket.destroyed){
                        logger.error('client socket closed,oop! '+request.url);
                        response.end();
                        proxy_response.socket.destroy();
                        proxy_request.abort();
                        if(timeOuter){
                            clearTimeout(timeOuter);
                            timeOuter = false;
                        }
                    }else response.write(chunk, 'binary');
                });

                proxy_response.addListener('end', function() {
                    response.end();
                    logger.info(util.format('Write data to client(%s) finish, used proxy: %s, cost: %s ms, url: %s',request.socket
.remoteAddress,proxyAddr,(new Date()).getTime()-startTime,request.url));
                    remote_proxy_response = null;//reset
                    if(timeOuter){
                        clearTimeout(timeOuter);
                        timeOuter = false;
                    }
                });

                proxy_response.headers['remoteproxy'] = util.format('%s:%d',remoteProxyHost,remoteProxyPort);
                response.writeHead(proxy_response.statusCode, proxy_response.headers);
                //response.write(util.format('&lt;!--%s:%d--&gt;',remoteProxyHost,remoteProxyPort), 'binary');
                logger.debug(util.format('Remote proxy response, %d, length: %s, cost: %dms, url:%s',proxy_response.statusCode,proxy_response
.headers['Content-Length'],(new Date()).getTime()-timer_start,request.url));
            });

            proxy_request.addListener('timeout', function() {
                proxyRouter.__voteProxy(domain,proxyAddr,false);
                response.end();
                proxy_request.abort(); ...</pre></li>
    <li>example usage<pre class="apidocCodePre">...
   myredis.createClient(
       self.settings['proxy_info_redis_db'][0],
       self.settings['proxy_info_redis_db'][1],
       self.settings['proxy_info_redis_db'][2],
       dbtype,
       function(err,cli){
           self.redis_cli3 = cli;
           self.<span class="apidocCodeKeywordSpan">proxyDaemon</span>();
       });
}

/**
* TOP Domain,e.g: www.baidu.com  -&gt; baidu.com
* @param domain
* @returns {*}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.index.prototype.start" id="apidoc.element.neocrawler.index.prototype.start">
        function <span class="apidocSignatureSpan">neocrawler.index.prototype.</span>start
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">start = function (){
    var self = this;
    var dbtype = 'redis';
    if(self.settings['use_ssdb'])dbtype = 'ssdb';
    myredis.createClient(
        self.settings['proxy_info_redis_db'][0],
        self.settings['proxy_info_redis_db'][1],
        self.settings['proxy_info_redis_db'][2],
        dbtype,
        function(err,cli){
            self.redis_cli3 = cli;
            self.proxyDaemon();
        });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
);
var logger = log4js.getLogger('shuttle');
logger.setLevel('DEBUG');
settings['logger'] = logger;
settings['port'] = 1985;
var gfw_proxy = new (require('./gfw-proxy.js'))(settings);

gfw_proxy.<span class="apidocCodeKeywordSpan">start</span>();
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.line_reader" id="apidoc.module.neocrawler.line_reader">module neocrawler.line_reader</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.line_reader.eachLine" id="apidoc.element.neocrawler.line_reader.eachLine">
        function <span class="apidocSignatureSpan">neocrawler.line_reader.</span>eachLine
        <span class="apidocSignatureSpan">(filename, cb, separator, encoding, bufferSize)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function eachLine(filename, cb, separator, encoding, bufferSize) {
    var finalFn,
        asyncCb = cb.length == 3;

    function finish() {
        if (finalFn &amp;&amp; typeof finalFn === 'function') {
            finalFn();
        }
    }

    open(filename, function(reader) {
        function newRead() {
            if (reader.hasNextLine()) {
                setImmediate(readNext);
            } else {
                finish();
            }
        }

        function continueCb(continueReading) {
            if (continueReading !== false) {
                newRead();
            } else {
                finish();
                reader.close();
            }
        }

        function readNext() {
            reader.nextLine(function(line) {
                var last = !reader.hasNextLine();

                if (asyncCb) {
                    cb(line, last, continueCb);
                } else {
                    if (cb(line, last) !== false) {
                        newRead();
                    } else {
                        finish();
                        reader.close();
                    }
                }
            });
        }

        newRead();
    }, separator, encoding, bufferSize);

    return {
        then: function(cb) {
            finalFn = cb;
        }
    };
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

var restoredb = function(db){
redis.createClient(options['h'],options['p'],db,options['t'],function(err,redis_cli)
{
    if(err)throw err;
    var count = 0;
    var key,value;
    lineReader.<span class="apidocCodeKeywordSpan">eachLine</span>(options['f'], function(line, last,cb) {
        if(count++%2==0){
            key = line;
            if(last){
                redis_cli.quit();
                cb(false);
            }else cb();
        }else {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.line_reader.open" id="apidoc.element.neocrawler.line_reader.open">
        function <span class="apidocSignatureSpan">neocrawler.line_reader.</span>open
        <span class="apidocSignatureSpan">(filename, cb, separator, encoding, bufferSize)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function open(filename, cb, separator, encoding, bufferSize) {
    fs.open(filename, 'r', parseInt('666', 8), function(err, fd) {
        var reader;
        if (err) {
            throw err;
        }

        reader = new LineReader(fd, function() {
            cb(reader);
        }, separator, encoding, bufferSize);
    });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
        this.nextLine = nextLine;
        this.close = close;

        readToSeparator(cb);
    }

    function open(filename, cb, separator, encoding, bufferSize) {
        fs.<span class="apidocCodeKeywordSpan">open</span>(filename, 'r', parseInt('666', 8), function(err,
fd) {
var reader;
if (err) {
    throw err;
}

reader = new LineReader(fd, function() {
    cb(reader);
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.logging" id="apidoc.module.neocrawler.logging">module neocrawler.logging</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.logging.getLogger" id="apidoc.element.neocrawler.logging.getLogger">
        function <span class="apidocSignatureSpan">neocrawler.logging.</span>getLogger
        <span class="apidocSignatureSpan">(name, instance, level)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">getLogger = function (name, instance, level){
	var log4js = require('log4js');
	log4js.configure({
					  "appenders": [
					                {
					                  "type": "dateFile",
					                  "filename": "logs/"+name+"-"+process.pid+".log",
					                  "pattern": "-yyyy-MM-dd",
					                  "alwaysIncludePattern": false
					                },
					                {
					                  "type": "console"
					                }
					              ]
		            },
		            {cwd: 'instance/'+instance }
		            );
	var logger = log4js.getLogger(name);
	logger.setLevel(level);
	return logger;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
					                {
					                  "type": "console"
					                }
					              ]
		            },
		            {cwd: 'instance/'+instance }
		            );
	var logger = log4js.<span class="apidocCodeKeywordSpan">getLogger</span>(name);
	logger.setLevel(level);
	return logger;
}
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.myredis" id="apidoc.module.neocrawler.myredis">module neocrawler.myredis</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.myredis.createClient" id="apidoc.element.neocrawler.myredis.createClient">
        function <span class="apidocSignatureSpan">neocrawler.myredis.</span>createClient
        <span class="apidocSignatureSpan">(host, port, db, type, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">createClient = function (host, port, db, type, callback){
    if(type=='ssdb'){
        var ssdb_cli = ssdb.client(host,port);
        callback(null,ssdb_cli);
    }else{
        var redis_cli = redis.createClient(port,host);
        redis_cli.hlist = function(name,callback){
            redis_cli.keys(name,callback);
        };
        redis_cli.hclear = function(name,callback){
            redis_cli.del(name,callback);
        };
        redis_cli.zlen = function(name,callback){
            redis_cli.zcount(name,0,(new Date()).getTime(),callback);
        };
        redis_cli.zlist = function(name,callback){
            redis_cli.keys(name,callback);
        };
        redis_cli.qlist = function(name,callback){
            redis_cli.keys(name,callback);
        };
        redis_cli.close = function(){
            redis_cli.quit();
        };
        redis_cli.select(db, function(err,value) {
            callback(err,redis_cli);
        });
    }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var ssdb = require("./ssdb_redis.js");

exports.createClient = function(host,port,db,type,callback){
if(type=='ssdb'){
    var ssdb_cli = ssdb.client(host,port);
    callback(null,ssdb_cli);
}else{
    var redis_cli = redis.<span class="apidocCodeKeywordSpan">createClient</span>(port,host);
    redis_cli.hlist = function(name,callback){
        redis_cli.keys(name,callback);
    };
    redis_cli.hclear = function(name,callback){
        redis_cli.del(name,callback);
    };
    redis_cli.zlen = function(name,callback){
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.qqwry" id="apidoc.module.neocrawler.qqwry">module neocrawler.qqwry</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.qqwry.DBUG" id="apidoc.element.neocrawler.qqwry.DBUG">
        function <span class="apidocSignatureSpan">neocrawler.qqwry.</span>DBUG
        <span class="apidocSignatureSpan">(a)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">DBUG = function (a){dbug = a != undefined ? a : true; return this;}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.qqwry.info" id="apidoc.element.neocrawler.qqwry.info">
        function <span class="apidocSignatureSpan">neocrawler.qqwry.</span>info
        <span class="apidocSignatureSpan">(dataPath)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">info = function (dataPath){
    var fs = require('fs'),
        Path = typeof(dataPath) == "string" ? dataPath : pathDefined;
    var callback = typeof arguments[arguments.length-1] == "function" ? arguments[arguments.length-1] : function(){};
    GBK = require("./gbk.js");
    ipFileBuffer = fs.readFileSync(Path); //IP;
    ipBegin = ipFileBuffer.readUInt32LE(0,true); //;
    ipEnd = ipFileBuffer.readUInt32LE(4,true); //;
    ipCount = (ipEnd-ipBegin)/7+1;
    dbug &amp;&amp; log("==== Lib-qqwry Start! ==== [Begin:"+ipBegin+" End:"+ipEnd + " Count:" + ipCount + "]");
    uninfo = false;
    callback();
    return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    if(self.availableProxies[domain][ip]){
        logger.debug('Vote '+ip+' available to cache, '+domain);
        if(callback)callback();
    }else {
        self.availableProxies[domain][ip] = true;
        self.redis_cli3.lpush(PROXY_KEYS,ip,function(err){
            if(err)logger.error('Encountered error vote proxy to redis');
            else logger.<span class="apidocCodeKeywordSpan">info</span>('Vote '+ip+' available to redis, '+domain
);
            if(callback)callback(err);
        });
    }
}else{
    if(ip)delete self.availableProxies[domain][ip];
    logger.warn('Vote '+ip+' not available');
    if(callback)callback();
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.qqwry.infoAsync" id="apidoc.element.neocrawler.qqwry.infoAsync">
        function <span class="apidocSignatureSpan">neocrawler.qqwry.</span>infoAsync
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">infoAsync = function (){
    var o = this,args = arguments;
    setTimeout(function(){o.info.apply(o,args)});
    return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.qqwry.intToIP" id="apidoc.element.neocrawler.qqwry.intToIP">
        function <span class="apidocSignatureSpan">neocrawler.qqwry.</span>intToIP
        <span class="apidocSignatureSpan">(INT)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">intToIP = function (INT){
    if(INT &lt; 0 || INT &gt; 0xFFFFFFFF){
        throw ("The number is not normal! &gt;&gt; " + INT);
    };
    return (INT&gt;&gt;&gt;24) + "." + (INT&gt;&gt;&gt;16 &amp; 0xFF) + "." + (INT&gt;&gt;&gt;8 &amp; 0xFF) + "." + (INT&gt;&gt;&gt;0 &amp; 0xFF);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
exports.searchIP = function(IP){
    uninfo &amp;&amp; uninfo();
    var ip = this.ipToInt(IP),
        g = LocateIP(ip),
        loc={};
    if(g == -1){return {"ip":IP,"Country":unArea,"Area":unCountry};}
    var add = setIPLocation(g);
    loc.ip = this.<span class="apidocCodeKeywordSpan">intToIP</span>(ip);
    loc.Country = add.Country;
    loc.Area = add.Area;
    dbug &amp;&amp; log(loc);
    return loc;
}

//IP;scope
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.qqwry.ipEndianChange" id="apidoc.element.neocrawler.qqwry.ipEndianChange">
        function <span class="apidocSignatureSpan">neocrawler.qqwry.</span>ipEndianChange
        <span class="apidocSignatureSpan">(INT)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">ipEndianChange = function (INT){
    INT = INT &amp; 0xFFFFFFFF;
    return (INT &gt;&gt;&gt; 24 | (INT &gt;&gt; 8 &amp; 0xFF00) | (INT &lt;&lt; 8 &amp; 0xFF0000) | (INT &lt;&lt; 24)) &gt;&gt;&gt; 0;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.qqwry.ipToInt" id="apidoc.element.neocrawler.qqwry.ipToInt">
        function <span class="apidocSignatureSpan">neocrawler.qqwry.</span>ipToInt
        <span class="apidocSignatureSpan">(IP)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">ipToInt = function (IP){
    var result = IP_REGEXP.exec(IP),ip;
    if(result){
        var ip_Arr = result.slice(1);
        ip =(parseInt(ip_Arr[0]) &lt;&lt; 24
            | parseInt(ip_Arr[1]) &lt;&lt; 16
            | parseInt(ip_Arr[2]) &lt;&lt; 8
            | parseInt(ip_Arr[3])) &gt;&gt;&gt; 0;
    }else if(/^\d+$/.test(IP) &amp;&amp; (ip=parseInt(IP))&gt;=0 &amp;&amp; ip &lt;= 0xFFFFFFFF ){

    }else{
        throw ("The IP address is not normal! &gt;&gt; " + IP);
    }
    return ip;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
callback();
return this;
}

//IP
exports.searchIP = function(IP){
uninfo &amp;&amp; uninfo();
var ip = this.<span class="apidocCodeKeywordSpan">ipToInt</span>(IP),
    g = LocateIP(ip),
    loc={};
if(g == -1){return {"ip":IP,"Country":unArea,"Area":unCountry};}
var add = setIPLocation(g);
loc.ip = this.intToIP(ip);
loc.Country = add.Country;
loc.Area = add.Area;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.qqwry.searchIP" id="apidoc.element.neocrawler.qqwry.searchIP">
        function <span class="apidocSignatureSpan">neocrawler.qqwry.</span>searchIP
        <span class="apidocSignatureSpan">(IP)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">searchIP = function (IP){
    uninfo &amp;&amp; uninfo();
    var ip = this.ipToInt(IP),
        g = LocateIP(ip),
        loc={};
    if(g == -1){return {"ip":IP,"Country":unArea,"Area":unCountry};}
    var add = setIPLocation(g);
    loc.ip = this.intToIP(ip);
    loc.Country = add.Country;
    loc.Area = add.Area;
    dbug &amp;&amp; log(loc);
    return loc;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
            });
        }
    }
}
}

proxyRouter.prototype.ipInChina = function(ip){
var ipL = qqwry.<span class="apidocCodeKeywordSpan">searchIP</span>(ip);
var inChina = true;
if(ipL) {
    logger.debug(JSON.stringify(ipL));
    if (ipL['Country'].startsWith('') ||
        ipL['Country'].startsWith('') ||
        ipL['Country'].startsWith('') ||
        ipL['Country'].startsWith('') ||
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.qqwry.searchIPScope" id="apidoc.element.neocrawler.qqwry.searchIPScope">
        function <span class="apidocSignatureSpan">neocrawler.qqwry.</span>searchIPScope
        <span class="apidocSignatureSpan">(bginIP, endIP, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">searchIPScope = function (bginIP, endIP, callback){
    uninfo &amp;&amp; uninfo();
    var _ip1,_ip2,b_g,e_g,ips=[];
    try{_ip1 = this.ipToInt(bginIP);}catch(e){throw ("The bginIP is not normal! &gt;&gt; " + bginIP);}
    try{_ip2 = this.ipToInt(endIP);}catch(e){throw ("The endIP is not normal! &gt;&gt; " + endIP);}
    b_g = LocateIP(_ip1);
    e_g = LocateIP(_ip2);
    for(var i = b_g; i&lt;= e_g ; i+= IP_RECORD_LENGTH){
        var loc = {},add = setIPLocation(i);
        loc.begIP = this.intToIP(ipFileBuffer.readUInt32LE(i,true));
        loc.endIP = this.intToIP(ipFileBuffer.readUInt32LE(setBuffer3(i+4),true));
        loc.Country = add.Country;
        loc.Area = add.Area;
        ips.push(loc);
    }
    if(typeof callback === "function"){callback(ips);}
    return ips;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var o = this,args = arguments;
setTimeout(function(){o.info.apply(o,args)});
return this;
}

exports.searchIPScopeAsync = function(a,b,c){
var o = this;
setTimeout(function(){o.<span class="apidocCodeKeywordSpan">searchIPScope</span>(a,b,c)});
return this;
}

//
function setIPLocation(g){
var ipwz = setBuffer3(g+4) + 4;
var lx = ipFileBuffer.readUInt8(ipwz),
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.qqwry.searchIPScopeAsync" id="apidoc.element.neocrawler.qqwry.searchIPScopeAsync">
        function <span class="apidocSignatureSpan">neocrawler.qqwry.</span>searchIPScopeAsync
        <span class="apidocSignatureSpan">(a, b, c)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">searchIPScopeAsync = function (a, b, c){
    var o = this;
    setTimeout(function(){o.searchIPScope(a,b,c)});
    return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.routecontroller" id="apidoc.module.neocrawler.routecontroller">module neocrawler.routecontroller</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.routecontroller.mapRoute" id="apidoc.element.neocrawler.routecontroller.mapRoute">
        function <span class="apidocSignatureSpan">neocrawler.routecontroller.</span>mapRoute
        <span class="apidocSignatureSpan">(app)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">mapRoute = function (app) {
	//prefix = '/' + prefix;

	prefix_rule = '/rule';
	prefix_proxy = '/proxy';
    prefix_monitor = '/monitor';

	var prefixRuleObj = require('./controllers' + prefix_rule);
	var prefixProxyObj = require('./controllers' + prefix_proxy);
    var prefixMonitorObj = require('./controllers' + prefix_monitor);

	// index
	app.get(prefix_rule, prefixRuleObj.index);
	
	// search
	app.post(prefix_rule + '/search', prefixRuleObj.search);	
	// add
	app.get(prefix_rule + '/new', prefixRuleObj.new);
	// show
	app.get(prefix_rule + '/:id', prefixRuleObj.show);
	// create
	app.post(prefix_rule + '/create', prefixRuleObj.create);
	// edit
	app.get(prefix_rule + '/:id/edit', prefixRuleObj.edit);
	// update
	app.post(prefix_rule + '/upsert', prefixRuleObj.update);
	// destroy
	app.del(prefix_rule + '/:id', prefixRuleObj.destroy);
	
/////////////////////////////////////////////////////////////////////
	// Proxy index
	app.get(prefix_proxy, prefixProxyObj.index);
	// Proxy index
	app.get(prefix_proxy + '/index', prefixProxyObj.index);	
	// Proxy edit
	app.get(prefix_proxy + "/new", prefixProxyObj.new);
	// Proxy create
	app.post(prefix_proxy + "/create", prefixProxyObj.create);
	// Proxy destroy
	app.get(prefix_proxy + "/:host/:key", prefixProxyObj.destroy);

/////////////////////////////////////////////////////////////////////////

    app.get(prefix_monitor + "/daily", prefixMonitorObj.daily);
    app.get(prefix_monitor + "/linkdb", prefixMonitorObj.linkdb);
    app.get(prefix_monitor + "/chart", prefixMonitorObj.chart);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  		return (username == settings['config_web_auth'][0] &amp;&amp; password == settings['config_web_auth'][
1]);
	},'Restrict area, please identify');	
	
	app.all("*", basicAuth);
	}

        app.get('/', routes.index);
	controller.<span class="apidocCodeKeywordSpan">mapRoute</span>(app);

	console.log('create server.');
	http.createServer(app).listen(app.get('port'), function(){
		console.log('webconfig server listening on port ' + app.get('port'));
	});
}
////////////////////////////////////////
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.scan" id="apidoc.module.neocrawler.scan">module neocrawler.scan</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.scan.Scan" id="apidoc.element.neocrawler.scan.Scan">
        function <span class="apidocSignatureSpan">neocrawler.scan.</span>Scan
        <span class="apidocSignatureSpan">(table, startRow, stopRow, client)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Scan(table, startRow, stopRow, client) {
  this.table = table;
  this.startRow = startRow;
  this.stopRow = stopRow;
  this.client = client;
  this.toArray = __bind(this.toArray, this);
  this.each = __bind(this.each, this);
  this.close = __bind(this.close, this);
  this.next = __bind(this.next, this);
  this.getServerAndLocation = __bind(this.getServerAndLocation, this);
  this._processResponse = __bind(this._processResponse, this);
  this._getData = __bind(this._getData, this);
  this.setFilter = __bind(this.setFilter, this);
  this.closed = false;
  this.numCached = 100;
  this.cached = [];
  this.server = null;
  this.location = null;
  this.timeout = null;
  this.row = 0;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    }
    if (_this.filter) {
      req.scan.filter = _this.filter;
    }
    _this.row++;
    region = _this.location.name.toString();
    debug("scan on: " + _this.table + " row: " + _this.row + " region: " + region + " startRow
: " + _this.startRow + " stopRow: " + _this.stopRow);
    return _this.server.rpc.<span class="apidocCodeKeywordSpan">Scan</span>(req, function(err, response) {
      if (err) {
        return cb(err);
      }
      return _this._processResponse(response, cb);
    });
  };
})(this));
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.scan.getFilter" id="apidoc.element.neocrawler.scan.getFilter">
        function <span class="apidocSignatureSpan">neocrawler.scan.</span>getFilter
        <span class="apidocSignatureSpan">(filter)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">getFilter = function (filter) {
  var FilterList, filterList, filterName, filterNameUpper, o, serialized;
  FilterList = require('./filter-list');
  if (filter instanceof FilterList) {
    filterList = new proto.FilterList(filter.get());
    o = {
      name: 'org.apache.hadoop.hbase.filter.FilterList',
      serializedFilter: filterList.encode()
    };
    return o;
  }
  filterName = Object.keys(filter)[0];
  filterNameUpper = "" + (filterName[0].toUpperCase()) + filterName.slice(1);
  if (!proto[filterNameUpper]) {
    throw new Error("Invalid filter " + filterNameUpper);
  }
  if (filterNameUpper === 'SingleColumnValueFilter') {
    filter[filterName].comparator = getFilter(filter[filterName].comparator);
  }
  o = {
    name: "org.apache.hadoop.hbase.filter." + filterNameUpper
  };
  serialized = 'serializedFilter';
  if (filterNameUpper.indexOf('Comparator') &gt;= 0) {
    serialized = 'serializedComparator';
  }
  o[serialized] = new proto[filterNameUpper](filter[filterName]).encode();
  return o;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.spider" id="apidoc.module.neocrawler.spider">module neocrawler.spider</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.spider.spider" id="apidoc.element.neocrawler.spider.spider">
        function <span class="apidocSignatureSpan">neocrawler.</span>spider
        <span class="apidocSignatureSpan">(spiderCore)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">spider = function (spiderCore){
    this.spiderCore = spiderCore;
    this.queue_length = 0;
    this.driller_rules_updated = 0;
    this.driller_rules = {};
    logger = spiderCore.settings.logger;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.spider.prototype" id="apidoc.module.neocrawler.spider.prototype">module neocrawler.spider.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.spider.prototype.__getTopLevelDomain" id="apidoc.element.neocrawler.spider.prototype.__getTopLevelDomain">
        function <span class="apidocSignatureSpan">neocrawler.spider.prototype.</span>__getTopLevelDomain
        <span class="apidocSignatureSpan">(domain)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">__getTopLevelDomain = function (domain){
    var arr = domain.split('.');
    if(arr.length&lt;=2)return domain;
    else return arr.slice(1).join('.');
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
 */
proxyRouter.prototype.proxyDaemon = function(){
var proxyRouter = this;
var httpProxyServer = http.createServer(function(request, response) {
    var timeOuter = false;
    var startTime = (new Date()).getTime();
    var urlobj = url.parse(request.url);
    var domain = proxyRouter.<span class="apidocCodeKeywordSpan">__getTopLevelDomain</span>(urlobj['hostname']);
    logger.info(util.format('Request %s from %s',request.url,request.socket.remoteAddress));
    //var proxy = http.createClient(80, request.headers['host']);
    //var proxy_request = proxy.request(request.method, request.url, request.headers);//202.171.253.98:80
    var route = true;
    proxyRouter.__chooseProxy(domain,request.socket.remoteAddress,request.headers,function(proxyAddr){
        if(route&amp;&amp;proxyAddr){
            var choseProxy = proxyAddr.split(':');
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.spider.prototype.assembly" id="apidoc.element.neocrawler.spider.prototype.assembly">
        function <span class="apidocSignatureSpan">neocrawler.spider.prototype.</span>assembly
        <span class="apidocSignatureSpan">(callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">assembly = function (callback){
    var self = this;
    var dbtype = 'redis';
    if(this.spiderCore.settings['use_ssdb'])dbtype = 'ssdb';
    async.series([
        function(cb){
            myredis.createClient(
                self.spiderCore.settings['driller_info_redis_db'][0],
                self.spiderCore.settings['driller_info_redis_db'][1],
                self.spiderCore.settings['driller_info_redis_db'][2],
                dbtype,
                function(err,cli){
                    self.redis_cli0 = cli;
                    cb(err);
                });
        },
        function(cb){
            myredis.createClient(
                self.spiderCore.settings['url_info_redis_db'][0],
                self.spiderCore.settings['url_info_redis_db'][1],
                self.spiderCore.settings['url_info_redis_db'][2],
                dbtype,
                function(err,cli){
                    self.redis_cli1 = cli;
                    cb(err);
                });
        },
        function(cb){
            myredis.createClient(
                self.spiderCore.settings['url_report_redis_db'][0],
                self.spiderCore.settings['url_report_redis_db'][1],
                self.spiderCore.settings['url_report_redis_db'][2],
                dbtype,
                function(err,cli){
                    self.redis_cli2 = cli;
                    cb(err);
                });
        }
    ],function(err,result){
        if(callback)callback(null,'done');
    });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.spider.prototype.checkQueue" id="apidoc.element.neocrawler.spider.prototype.checkQueue">
        function <span class="apidocSignatureSpan">neocrawler.spider.prototype.</span>checkQueue
        <span class="apidocSignatureSpan">(spider)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">checkQueue = function (spider){
    var breakTt = false;
    async.whilst(
        function() {
            logger.debug('Check queue, length: '+spider.queue_length);
            return spider.queue_length &lt; spider.spiderCore.settings['spider_concurrency'] &amp;&amp; breakTt !== true;
        },
        function(cb) {
            spider.getUrlQueue(function(bol){
                if(bol===true)spider.queue_length++;
                else breakTt = true;
                cb();
            });
        },
        function(err) {
            if(err)logger.error('Exception in check queue.');
        }
    );
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.spider.prototype.detectLink" id="apidoc.element.neocrawler.spider.prototype.detectLink">
        function <span class="apidocSignatureSpan">neocrawler.spider.prototype.</span>detectLink
        <span class="apidocSignatureSpan">(link)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">detectLink = function (link){
    var urlobj = url.parse(link);
    var result = '';
    var domain = this.__getTopLevelDomain(urlobj['hostname']);
    if(this.driller_rules[domain]!=undefined){
        var alias = this.driller_rules[domain];
        for(a in alias){
            if(alias.hasOwnProperty(a)){
                //var url_pattern  = decodeURIComponent(alias[a]['url_pattern']);
                var url_pattern  = alias[a]['url_pattern'];
                var patt = new RegExp(url_pattern);
                if(patt.test(link)){
                    result = 'driller:'+domain+':'+a;
                    break;
                }
            }
        }
    }
    return result;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
 * @param links
 * @returns {{}}
 */
extractor.prototype.arrange_link = function(links){
var linkobj = {};
for(var i=0;i&lt;links.length;i++){
    var link = links[i];
    var matched_driller = this.<span class="apidocCodeKeywordSpan">detectLink</span>(link);
    if(matched_driller.length&gt;0){
        var driller_lib = 'urllib:' + matched_driller[0];
        var driller_rule = matched_driller[1];
        if(typeof(driller_rule)!='object')driller_rule = JSON.parse(driller_rule);
        if(linkobj[driller_lib]==undefined)linkobj[driller_lib]=[];
        if(driller_rule['id_parameter']&amp;&amp;driller_rule['id_parameter'].length&gt;0){
            var id_parameter = driller_rule['id_parameter'];
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.spider.prototype.getDrillerRule" id="apidoc.element.neocrawler.spider.prototype.getDrillerRule">
        function <span class="apidocSignatureSpan">neocrawler.spider.prototype.</span>getDrillerRule
        <span class="apidocSignatureSpan">(id, name)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">getDrillerRule = function (id, name){
    var splited_id = id.split(':');
    var pos = 1;
    if(splited_id[0]==='urllib')pos = 2;
    if(this.driller_rules[splited_id[pos]][splited_id[pos+1]]&amp;&amp;this.driller_rules[splited_id[pos]][splited_id[pos+1]].hasOwnProperty
(name)){
        return this.driller_rules[splited_id[pos]][splited_id[pos+1]][name];
    }else{
        logger.warn(util.format('%s in %s %s, not found',name,splited_id[pos],splited_id[pos+1]));
        return false;
    }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

var timeOuter = false;
var pageLink = urlinfo['url'];
if(urlinfo['redirect'])pageLink = urlinfo['redirect'];

var useProxy = false;
if(urlinfo['urllib']&amp;&amp;spiderCore.settings['use_proxy']===true){
    if(spiderCore.spider.<span class="apidocCodeKeywordSpan">getDrillerRule</span>(urlinfo['urllib'],'use_proxy&amp;#
x27;)===true)useProxy=true;
}

if(useProxy){
    var proxyRouter = spiderCore.settings['proxy_router'].split(':');
    var __host = proxyRouter[0];
    var __port = proxyRouter[1];
    var __path =  pageLink;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.spider.prototype.getDrillerRules" id="apidoc.element.neocrawler.spider.prototype.getDrillerRules">
        function <span class="apidocSignatureSpan">neocrawler.spider.prototype.</span>getDrillerRules
        <span class="apidocSignatureSpan">(id)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">getDrillerRules = function (id){
    var splited_id = id.split(':');
    var pos = 1;
    if(splited_id[0]==='urllib')pos = 2;
    if(this.driller_rules[splited_id[pos]] &amp;&amp; this.driller_rules[splited_id[pos]][splited_id[pos+1]]){
        return this.driller_rules[splited_id[pos]][splited_id[pos+1]];
    }else{
        logger.warn(util.format('%s%s, not exists',splited_id[pos],splited_id[pos+1]));
        return null;
    }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
        spider.getUrlQueue(callback);
    }
}else{
    if(!link_info['trace']){
        logger.warn(link+', url info is incomplete');
        spider.getUrlQueue(callback);
    }else{
        var drillerinfo = spider.<span class="apidocCodeKeywordSpan">getDrillerRules</span>(link_info['trace']);
            if(drillerinfo==null){
                redis_urlinfo_db.del(linkhash,function(err){
                    logger.warn(link+', has dirty driller info! clean it');
                    var urlinfo = spider.wrapLink(link);
                    if(urlinfo!=null)spider.spiderCore.emit('new_url_queue',urlinfo);
                    else{
                        logger.error('Cleaned dirty driller info for '+link+', but can not match any driller rule
 right now, ignore it.');
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.spider.prototype.getUrlQueue" id="apidoc.element.neocrawler.spider.prototype.getUrlQueue">
        function <span class="apidocSignatureSpan">neocrawler.spider.prototype.</span>getUrlQueue
        <span class="apidocSignatureSpan">(callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">getUrlQueue = function (callback){
    /*
     var urlinfo = {
     "url":"http://list.taobao.com/itemlist/sport2011a.htm?spm=1.6659421.a21471u.6.RQYJRM&amp;&amp;md=5221&amp;cat=50071853&amp;sd=0&amp;as=0&amp;viewIndex
=1&amp;atype=b&amp;style=grid&amp;same_info=1&amp;tid=0&amp;olu=yes&amp;isnew=2&amp;smc=1&amp;navid=city&amp;_input_charset=utf-8",
     "type":"branch",
     "referer":"http://www.taobao.com",
     "cookie":[],//require('./taobao-cookie-simple.json'),
     "jshandle":true,
     "inject_jquery":false,
     "drill_rules":[".vm-page-next",".general a","a"],
     "script":["jsexec_result = document.getElementById('pageJumpto').value;","jsexec_result=document.querySelector('.user-nick').
text"],//["jsexec_result = $.map($('.category li a span'),function(n,i) {return $(n).text();});"],//["jsexec_result=document.querySelector
('.user-nick').text;"]
     "navigate_rule":[".vm-page-next"],
     "stoppage":3,
     "url_lib_id":"urllib:driller:taobao.com:list"
     }
     */

    var spider = this;
    var redis_driller_db = this.redis_cli0;
    var redis_urlinfo_db = this.redis_cli1;
        redis_driller_db.lpop('queue:scheduled:all',function(err, link){
            //2----------------------------------------------------------------------------------------
            if(!link){
                logger.info('No candidate queue, '+spider.queue_length+' urls in crawling.');
                if('no_queue_alert' in spider.spiderCore.spider_extend)spider.spiderCore.spider_extend.no_queue_alert();
                if(callback){callback(false);return;}
            };//no queue
                var linkhash = crypto.createHash('md5').update(link).digest('hex');
                redis_urlinfo_db.hgetall(linkhash,function(err, link_info){
                    //4---------------------------------------------------------------------------------
                    if(err)throw(err);
                    if(!link_info||isEmpty(link_info)){
                        logger.warn(link+' has no url info, '+linkhash+', we try to match it');
                        var urlinfo = spider.wrapLink(link);
                        if(urlinfo!=null)spider.spiderCore.emit('new_url_queue',urlinfo);
                        else{
                            logger.error(link+' can not match any driller rule, ignore it.');
                            spider.getUrlQueue(callback);
                        }
                    }else{
                        if(!link_info['trace']){
                            logger.warn(link+', url info is incomplete');
                            spider.getUrlQueue(callback);
                        }else{
                            var drillerinfo = spider.getDrillerRules(link_info['trace']);
                                if(drillerinfo==null){
                                    redis_urlinfo_db.del(linkhash,function(err){
                                        logger.warn(link+', has dirty driller info! clean it');
                                        var urlinfo = spider.wrapLink(link);
                                        if(urlinfo!=null)spider.spiderCore.emit('new_url_queue',urlinfo);
                                        else{
                                            logger.error('Cleaned dirty driller info for '+link+', but can not match any driller
 rule right now, ignore it.');
                                            spider.getUrlQueue(callback);
                                        }
                                    });
                                }else{
                                    var urlinfo = {
                                        "url":link,
                                        "version":parseInt(link_info['version']),
                                        "type":drillerinfo['type'],
                                        "format":drillerinfo['format'],
                                        "encoding":drillerinfo['encoding'],
                                        "referer":link_info['referer'],
                                        "url_pattern":drillerinfo['url_patt ...</pre></li>
    <li>example usage<pre class="apidocCodePre">...
if(err)throw(err);
if(!link_info||isEmpty(link_info)){
    logger.warn(link+' has no url info, '+linkhash+', we try to match it');
    var urlinfo = spider.wrapLink(link);
    if(urlinfo!=null)spider.spiderCore.emit('new_url_queue',urlinfo);
    else{
        logger.error(link+' can not match any driller rule, ignore it.');
        spider.<span class="apidocCodeKeywordSpan">getUrlQueue</span>(callback);
    }
}else{
    if(!link_info['trace']){
        logger.warn(link+', url info is incomplete');
        spider.getUrlQueue(callback);
    }else{
        var drillerinfo = spider.getDrillerRules(link_info['trace']);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.spider.prototype.jsonSmartDeepParse" id="apidoc.element.neocrawler.spider.prototype.jsonSmartDeepParse">
        function <span class="apidocSignatureSpan">neocrawler.spider.prototype.</span>jsonSmartDeepParse
        <span class="apidocSignatureSpan">(obj)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">jsonSmartDeepParse = function (obj){
    var dataobj = {};
    var numberPattern = new RegExp("^\-?[0-9]+$");
    for(i in obj){
        if(obj.hasOwnProperty(i)){
            if(typeof(obj[i])==='string'&amp;&amp;(obj[i].charAt(0)==='{'||obj[i].charAt(0)==='[')){
                dataobj[i] = JSON.parse(obj[i]);
            }else if(numberPattern.test(obj[i])){
                dataobj[i] = parseInt(obj[i]);
            }else if(obj[i]==='true'){
                dataobj[i] = true;
            }else if(obj[i]==='false'){
                dataobj[i] = false;
            }else dataobj[i] = obj[i];
        }
    }
    return dataobj;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var redis_cli = this.redis_cli0;
redis_cli.hgetall(key, function(err,value){//for synchronized using object variable
    if(self.tmp_driller_rules==undefined)self.tmp_driller_rules = {};
    var isActive = value['active']=='true'||value['active']==true||value['active']=='
;1'||value['active']==1?true:false;
    if(isActive||self.spiderCore.settings['test']) {
        logger.info('Load rule: '+key);
        if (self.tmp_driller_rules[value['domain']] == undefined)self.tmp_driller_rules[value['domain']] = {};
        self.tmp_driller_rules[value['domain']][value['alias']] = self.<span class="apidocCodeKeywordSpan">jsonSmartDeepParse
</span>(value);
    }else logger.debug('Ignore rule: '+key+', status inactive');
    self.tmp_driller_rules_length--;
    if(self.tmp_driller_rules_length&lt;=0){
        self.driller_rules = self.tmp_driller_rules;
        //self.driller_rules_updated = (new Date()).getTime();
        self.spiderCore.emit('driller_rules_loaded',self.driller_rules);
        setTimeout(function(){self.refreshDrillerRules();},self.spiderCore.settings['check_driller_rules_interval']*1000
);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.spider.prototype.refreshDrillerRules" id="apidoc.element.neocrawler.spider.prototype.refreshDrillerRules">
        function <span class="apidocSignatureSpan">neocrawler.spider.prototype.</span>refreshDrillerRules
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">refreshDrillerRules = function (){
    var self = this;
    var redis_cli = this.redis_cli0;
        redis_cli.get('updated:driller:rule',function(err,value){
            if (err)throw(err);
            if(self.driller_rules_updated!==parseInt(value)){//driller is changed
                logger.info('driller rules is changed');
                redis_cli.hlist('driller:*',function(err,values){
                    if (err)throw(err);
                    self.tmp_driller_rules = {};
                    self.tmp_driller_rules_length = values.length;
                    for(var i=0;i&lt;values.length;i++){
                        self.wrapper_rules(values[i]);
                    }
                });
                self.driller_rules_updated=parseInt(value);
            }else{
                logger.debug('driller rules is not changed, queue length: '+self.queue_length);
                setTimeout(function(){self.refreshDrillerRules();},self.spiderCore.settings['check_driller_rules_interval']*1000
);
            }
        })
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
                for(var i=0;i&lt;values.length;i++){
                    self.wrapper_rules(values[i]);
                }
            });
            self.driller_rules_updated=parseInt(value);
        }else{
            logger.debug('driller rules is not changed, queue length: '+self.queue_length);
            setTimeout(function(){self.<span class="apidocCodeKeywordSpan">refreshDrillerRules</span>();},self.spiderCore.settings
['check_driller_rules_interval']*1000);
        }
    })
}
//wrapper each rule
spider.prototype.wrapper_rules = function(key){
var self = this;
var redis_cli = this.redis_cli0;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.spider.prototype.retryCrawl" id="apidoc.element.neocrawler.spider.prototype.retryCrawl">
        function <span class="apidocSignatureSpan">neocrawler.spider.prototype.</span>retryCrawl
        <span class="apidocSignatureSpan">(urlinfo)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">retryCrawl = function (urlinfo){
    var spider = this;
    var retryLimit = 3;
    if(spider.spiderCore.settings['download_retry']&amp;&amp;spider.spiderCore.settings['download_retry']!=undefined){
        retryLimit = spider.spiderCore.settings['download_retry'];
    }
    var act_retry = 0;
    if(urlinfo['retry'])act_retry = urlinfo['retry'];

    if(act_retry&lt;retryLimit){
        urlinfo['retry'] = act_retry+1;
        logger.info(util.format('Retry url: %s, time: ',urlinfo['url'],urlinfo['retry']));
        spider.spiderCore.emit('new_url_queue',urlinfo);
        if('crawl_retry_alert' in spider.spiderCore.spider_extend)spider.spiderCore.spider_extend.crawl_retry_alert(urlinfo);//report
    }else{
        spider.updateLinkState(urlinfo['url'],'crawled_failure');
        logger.error(util.format('after %s reties, give up crawl %s',urlinfo['retry'],urlinfo['url']));
        spider.redis_cli2.zadd('fail:'+urlinfo['urllib'],urlinfo['version'],urlinfo['url'],function(err,result){
            spider.spiderCore.emit('slide_queue');
        });
        if('crawl_fail_alert' in spider.spiderCore.spider_extend)spider.spiderCore.spider_extend.crawl_fail_alert(urlinfo);//report
    }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.spider.prototype.updateLinkState" id="apidoc.element.neocrawler.spider.prototype.updateLinkState">
        function <span class="apidocSignatureSpan">neocrawler.spider.prototype.</span>updateLinkState
        <span class="apidocSignatureSpan">(link, state, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">updateLinkState = function (link, state, callback){
    var spider = this;
    var urlhash = crypto.createHash('md5').update(link+'').digest('hex');
    this.redis_cli1.hgetall(urlhash,function(err,link_info){
        if(err){
            logger.error('get state of link('+link+') fail: '+err);
            if(callback)callback(err);
            return;
        }
        if(link_info&amp;&amp;!isEmpty(link_info)){
            var t_record = link_info['records'];
            var records = [];
            if(t_record!=''&amp;&amp;t_record!='[]'){
                try{
                    records = JSON.parse(t_record);
                }catch(e){
                    logger.error(t_record+' JSON parse error: '+e);
                }
            }
            records.push(state);
            async.parallel([
                    function(cb){
                        spider.redis_cli1.hmset(urlhash,{'records':JSON.stringify(records.length&gt;3?records.slice(-3):records),'last
':(new Date()).getTime(),'status':state},function(err,link_info){
                            if(err)logger.error('update state of link('+link+') fail: '+err);
                            else logger.debug('update state of link('+link+') success: '+state);
                            cb(err);
                        });
                    },
                    function(cb){
                        if(state=='crawled_finish'){
                            spider.redis_cli2.zrem('fail:'+link_info['trace'],link,function(err,result){
                                logger.debug('remove '+link+' from fail:'+link_info['trace']);
                                cb(err);
                            });
                        }else cb(null);
                    }
                ],
                function(err, results){
                    if(callback)callback(err);
                });
        }else{
            var trace = spider.detectLink(link);
            if(trace!=''){
                trace = 'urllib:' + trace;
                var urlinfo = {
                    'url':link,
                    'trace':trace,
                    'referer':'',
                    'create':(new Date()).getTime(),
                    'records':JSON.stringify([]),
                    'last':(new Date()).getTime(),
                    'status':state
                }

                async.parallel([
                        function(cb){
                            spider.redis_cli1.hmset(urlhash,urlinfo,function(err, value){
                                if (err) throw(err);
                                logger.debug('save new url info: '+link);
                                cb(err);
                            });
                        },
                        function(cb){
                            if(state==='crawled_finish'){
                                spider.redis_cli2.zrem('fail:'+urlinfo['trace'],link,function(err,result){
                                    logger.debug('remove '+link+' from fail:'+urlinfo['trace']);
                                    cb(err);
                                });
                            }else cb(null);
                        }
                    ],
                    function(err, results){
                        if(callback)callback(err);
                    });
            }else {
                logger.error(link+' can not match any rules, ignore updating.');
                if(callback)callback(err);
            }
        }
    });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

    if(act_retry&lt;retryLimit){
        urlinfo['retry'] = act_retry+1;
        logger.info(util.format('Retry url: %s, time: ',urlinfo['url'],urlinfo['retry']));
        spider.spiderCore.emit('new_url_queue',urlinfo);
        if('crawl_retry_alert' in spider.spiderCore.spider_extend)spider.spiderCore.spider_extend.crawl_retry_alert(urlinfo
);//report
    }else{
        spider.<span class="apidocCodeKeywordSpan">updateLinkState</span>(urlinfo['url'],'crawled_failure');
        logger.error(util.format('after %s reties, give up crawl %s',urlinfo['retry'],urlinfo['url'
;]));
        spider.redis_cli2.zadd('fail:'+urlinfo['urllib'],urlinfo['version'],urlinfo['url'
;],function(err,result){
            spider.spiderCore.emit('slide_queue');
        });
        if('crawl_fail_alert' in spider.spiderCore.spider_extend)spider.spiderCore.spider_extend.crawl_fail_alert(urlinfo
);//report
    }
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.spider.prototype.wrapLink" id="apidoc.element.neocrawler.spider.prototype.wrapLink">
        function <span class="apidocSignatureSpan">neocrawler.spider.prototype.</span>wrapLink
        <span class="apidocSignatureSpan">(link)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">wrapLink = function (link){
    var linkinfo = null;
    var driller = this.detectLink(link);
    if(driller!=''){
        var driller_arr = driller.split(':');
        var drillerinfo = this.driller_rules[driller_arr[1]][driller_arr[2]];
        linkinfo = {
            "url":link,
            "version":(new Date()).getTime(),
            "type":drillerinfo['type'],
            "format":drillerinfo['format'],
            "encoding":drillerinfo['encoding'],
            "referer":"",
            "url_pattern":drillerinfo['url_pattern'],
            "urllib":'urllib:'+driller,
            "save_page":drillerinfo['save_page'],
            "cookie":drillerinfo['cookie'],
            "jshandle":drillerinfo['jshandle'],
            "inject_jquery":drillerinfo['inject_jquery'],
            "drill_rules":drillerinfo['drill_rules'],
            "drill_relation":'*',
            "validation_keywords":drillerinfo['validation_keywords']&amp;&amp;drillerinfo['validation_keywords']!='undefined'?drillerinfo
['validation_keywords']:'',
            "script":drillerinfo['script'],
            "navigate_rule":drillerinfo['navigate_rule'],
            "stoppage":drillerinfo['stoppage']
        }
    }
    return linkinfo;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
            };//no queue
var linkhash = crypto.createHash('md5').update(link).digest('hex');
redis_urlinfo_db.hgetall(linkhash,function(err, link_info){
    //4---------------------------------------------------------------------------------
    if(err)throw(err);
    if(!link_info||isEmpty(link_info)){
        logger.warn(link+' has no url info, '+linkhash+', we try to match it');
        var urlinfo = spider.<span class="apidocCodeKeywordSpan">wrapLink</span>(link);
        if(urlinfo!=null)spider.spiderCore.emit('new_url_queue',urlinfo);
        else{
            logger.error(link+' can not match any driller rule, ignore it.');
            spider.getUrlQueue(callback);
        }
    }else{
        if(!link_info['trace']){
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.spider.prototype.wrapper_rules" id="apidoc.element.neocrawler.spider.prototype.wrapper_rules">
        function <span class="apidocSignatureSpan">neocrawler.spider.prototype.</span>wrapper_rules
        <span class="apidocSignatureSpan">(key)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">wrapper_rules = function (key){
    var self = this;
    var redis_cli = this.redis_cli0;
    redis_cli.hgetall(key, function(err,value){//for synchronized using object variable
        if(self.tmp_driller_rules==undefined)self.tmp_driller_rules = {};
        var isActive = value['active']=='true'||value['active']==true||value['active']=='1'||value['active']==1?true:false;
        if(isActive||self.spiderCore.settings['test']) {
            logger.info('Load rule: '+key);
            if (self.tmp_driller_rules[value['domain']] == undefined)self.tmp_driller_rules[value['domain']] = {};
            self.tmp_driller_rules[value['domain']][value['alias']] = self.jsonSmartDeepParse(value);
        }else logger.debug('Ignore rule: '+key+', status inactive');
        self.tmp_driller_rules_length--;
        if(self.tmp_driller_rules_length&lt;=0){
            self.driller_rules = self.tmp_driller_rules;
            //self.driller_rules_updated = (new Date()).getTime();
            self.spiderCore.emit('driller_rules_loaded',self.driller_rules);
            setTimeout(function(){self.refreshDrillerRules();},self.spiderCore.settings['check_driller_rules_interval']*1000);
        }
    });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
if(self.driller_rules_updated!==parseInt(value)){//driller is changed
    logger.info('driller rules is changed');
    redis_cli.hlist('driller:*',function(err,values){
        if (err)throw(err);
        self.tmp_driller_rules = {};
        self.tmp_driller_rules_length = values.length;
        for(var i=0;i&lt;values.length;i++){
            self.<span class="apidocCodeKeywordSpan">wrapper_rules</span>(values[i]);
        }
    });
    self.driller_rules_updated=parseInt(value);
}else{
    logger.debug('driller rules is not changed, queue length: '+self.queue_length);
    setTimeout(function(){self.refreshDrillerRules();},self.spiderCore.settings['check_driller_rules_interval']*1000);
}
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.ssdb_redis" id="apidoc.module.neocrawler.ssdb_redis">module neocrawler.ssdb_redis</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.ssdb_redis.client" id="apidoc.element.neocrawler.ssdb_redis.client">
        function <span class="apidocSignatureSpan">neocrawler.ssdb_redis.</span>client
        <span class="apidocSignatureSpan">(host, port)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">client = function (host, port){
    return new redis_cli(host,port);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
 */

var redis = require("redis");
var ssdb = require("./ssdb_redis.js");

exports.createClient = function(host,port,db,type,callback){
if(type=='ssdb'){
    var ssdb_cli = ssdb.<span class="apidocCodeKeywordSpan">client</span>(host,port);
    callback(null,ssdb_cli);
}else{
    var redis_cli = redis.createClient(port,host);
    redis_cli.hlist = function(name,callback){
        redis_cli.keys(name,callback);
    };
    redis_cli.hclear = function(name,callback){
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.utils" id="apidoc.module.neocrawler.utils">module neocrawler.utils</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.utils.bufferCompare" id="apidoc.element.neocrawler.utils.bufferCompare">
        function <span class="apidocSignatureSpan">neocrawler.utils.</span>bufferCompare
        <span class="apidocSignatureSpan">(a, b)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">bufferCompare = function (a, b) {
  var i, len1, len2, _a, _b, _i, _ref;
  len1 = a.length;
  len2 = b.length;
  if (a === b &amp;&amp; len1 === len2) {
    return 0;
  }
  for (i = _i = 0, _ref = len1 - 1; 0 &lt;= _ref ? _i &lt;= _ref : _i &gt;= _ref; i = 0 &lt;= _ref ? ++_i : --_i) {
    if (a[i] !== b[i]) {
      _a = a[i] ? a[i] : 0;
      _b = b[i] ? b[i] : 0;
      return _a - _b;
    }
  }
  return len1 - len2;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
len = response.results.length;
if (len === this.numCached) {
  nextRegion = false;
}
if (this.location.endKey.length === 0) {
  nextRegion = false;
}
if (this.stopRow &amp;&amp; utils.<span class="apidocCodeKeywordSpan">bufferCompare</span>(this.location.endKey, new Buffer(this
.stopRow)) &gt; 0 &amp;&amp; len !== this.numCached) {
  nextRegion = false;
}
if (len &lt; this.numCached) {
  this.nextStartRow = utils.bufferIncrement(this.location.endKey);
  this.nextStartRow = this.nextStartRow.toString();
}
if (nextRegion) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.neocrawler.utils.bufferIncrement" id="apidoc.element.neocrawler.utils.bufferIncrement">
        function <span class="apidocSignatureSpan">neocrawler.utils.</span>bufferIncrement
        <span class="apidocSignatureSpan">(buffer, i)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">bufferIncrement = function (buffer, i) {
  var b, newBuffer, tmp;
  b = new Buffer(buffer);
  if (i == null) {
    i = b.length - 1;
  }
  if (i &lt; 0) {
    return Buffer.concat([new Buffer([1]), b]);
  }
  tmp = new Buffer([parseInt(b[i]++)]);
  if (tmp[0] &gt; b[i]) {
    newBuffer = _this.bufferIncrement(b, i - 1);
  }
  if (newBuffer &amp;&amp; b.length &lt; newBuffer.length) {
    return newBuffer;
  }
  return b;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
if (this.location.endKey.length === 0) {
  nextRegion = false;
}
if (this.stopRow &amp;&amp; utils.bufferCompare(this.location.endKey, new Buffer(this.stopRow)) &gt; 0 &amp;&amp; len !==
this.numCached) {
  nextRegion = false;
}
if (len &lt; this.numCached) {
  this.nextStartRow = utils.<span class="apidocCodeKeywordSpan">bufferIncrement</span>(this.location.endKey);
  this.nextStartRow = this.nextStartRow.toString();
}
if (nextRegion) {
  this.closeScan(this.server, this.location, this.scannerId);
  this.server = this.location = this.scannerId = null;
  if (len === 0) {
    return this._getData(this.nextStartRow, cb);
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.webconfig" id="apidoc.module.neocrawler.webconfig">module neocrawler.webconfig</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.webconfig.webconfig" id="apidoc.element.neocrawler.webconfig.webconfig">
        function <span class="apidocSignatureSpan">neocrawler.</span>webconfig
        <span class="apidocSignatureSpan">(webconfigCore)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">webconfig = function (webconfigCore){
	events.EventEmitter.call(this);
	this.webconfigCore = webconfigCore;
	logger = webconfigCore.settings.logger;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.neocrawler.webconfig.prototype" id="apidoc.module.neocrawler.webconfig.prototype">module neocrawler.webconfig.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.neocrawler.webconfig.prototype.launch" id="apidoc.element.neocrawler.webconfig.prototype.launch">
        function <span class="apidocSignatureSpan">neocrawler.webconfig.prototype.</span>launch
        <span class="apidocSignatureSpan">(settings)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">launch = function (settings){

	var app = express();
	// all environments
	app.set('port', settings['port']);


	app.configure(function(){
	  app.set('views', __dirname + '/views');
	  app.set('view engine', 'ejs');
	  app.use(express.favicon());
//	  app.use(express.logger('dev'));
	  //
      app.use(express.cookieParser());
	  app.use(express.session({secret: '1234567890QWERTY'}));
 	  //
	  app.use(express.urlencoded());
	  app.use(express.staticCache({maxObjects: 100, maxLength: 512}));
	  app.use(stylus.middleware({
		src: __dirname + '/views'
		, dest: __dirname + '/public'
		}));
	  app.use(express.static(__dirname + '/public'));
	  app.use(express.bodyParser());
	  app.use(express.methodOverride());
	  app.use(app.router);
	  app.use(express.directory(__dirname + '/public'));
	  app.use(function(req, res, next){
	    throw new Error(req.url + ' not found');
	  });
	  app.use(function(err, req, res, next) {
	    if(err)console.error(err);
	    res.send(err.message);
	  });
	});
	// development only
	if ('development' == app.get('env')) {
		app.use(express.errorHandler());
	}
	
        // Authenticator
        //app.use(express.basicAuth('config','config123'));//for 2.x
	if(settings['config_web_auth']){
	var basicAuth = express.basicAuth(function(username, password) {
  		return (username == settings['config_web_auth'][0] &amp;&amp; password == settings['config_web_auth'][1]);
	},'Restrict area, please identify');	
	
	app.all("*", basicAuth);
	}

        app.get('/', routes.index);
	controller.mapRoute(app);

	console.log('create server.');
	http.createServer(app).listen(app.get('port'), function(){
		console.log('webconfig server listening on port ' + app.get('port'));
	});
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocFooterDiv">
    [ this document was created with
    <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a>
    ]
</div>
</div>
</body></html>